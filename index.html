<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisis Commons - Complete System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --bg-card: #1a1a1a;
            --text: #ffffff;
            --text-dim: #808080;
            --green: #00ff88;
            --blue: #00ddff;
            --purple: #9945ff;
            --red: #ff3366;
            --yellow: #ffaa00;
            --border: #2a2a2a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .pod-title {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 16px;
        }

        .pod-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 1.2rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-weight: 600;
            color: var(--green);
        }

        .stat-label {
            color: var(--text-dim);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 40px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 12px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-tab:hover {
            color: var(--text);
        }

        .nav-tab.active {
            background: var(--bg);
            color: var(--green);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* View Mode Toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .view-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: var(--green);
            color: var(--bg);
            border-color: var(--green);
        }

        /* Collapsible Triads - Icon View */
        .triads {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .triad {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .triad.collapsed {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .triad-header {
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .triad-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .triad-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .collapse-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .triad.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .triad-title {
            font-size: 0.75rem;
            letter-spacing: 3px;
            color: var(--text-dim);
        }

        .triad-description {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .triad-summary {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .role-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .role-indicator.filled {
            background: var(--green);
        }

        .role-indicator.empty {
            background: var(--red);
        }

        .triad-status {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Roles Content - Collapsible */
        .roles-content {
            padding: 0 24px 24px;
            max-height: 1000px;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .triad.collapsed .roles-content {
            max-height: 0;
            opacity: 0;
            padding: 0 24px;
            overflow: hidden;
        }

        /* Icon View - Compact */
        .roles.icon-view {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .role.icon-view {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            width: calc(33.333% - 11px);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .role.icon-view:hover {
            transform: translateY(-2px);
            border-color: var(--green);
        }

        .role.icon-view.filled {
            border-color: var(--green);
        }

        .role.icon-view.empty {
            border-color: var(--red);
            opacity: 0.8;
        }

        .role-compact {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
        }

        .role-icon {
            font-size: 2rem;
        }

        .role-name {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .role-people-count {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(0, 255, 136, 0.1);
            color: var(--green);
        }

        .role-people-count.empty {
            background: rgba(255, 51, 102, 0.1);
            color: var(--red);
        }

        /* Table View */
        .roles.table-view {
            width: 100%;
        }

        .role-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .role-table th {
            text-align: left;
            padding: 8px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        .role-table td {
            padding: 12px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .role-table tr td:first-child {
            border-radius: 8px 0 0 8px;
        }

        .role-table tr td:last-child {
            border-radius: 0 8px 8px 0;
        }

        .role-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .role-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.filled {
            background: var(--green);
        }

        .status-dot.empty {
            background: var(--red);
        }

        .people-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .person-tag {
            padding: 2px 8px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--green);
        }

        .person-tag.backup {
            background: rgba(255, 170, 0, 0.1);
            border-color: rgba(255, 170, 0, 0.3);
            color: var(--yellow);
        }

        .empty-tag {
            padding: 2px 8px;
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid rgba(255, 51, 102, 0.3);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--red);
            font-style: italic;
        }

        .add-btn {
            padding: 2px 8px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        /* Flows Tab */
        .operator-model {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }

        .core-operator {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
        }

        .core-operator.shares {
            border-color: var(--blue);
        }

        .core-operator.okays {
            border-color: var(--purple);
        }

        .core-operator.does {
            border-color: var(--green);
        }

        .core-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .core-title {
            font-size: 1.3rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .shares .core-title { color: var(--blue); }
        .okays .core-title { color: var(--purple); }
        .does .core-title { color: var(--green); }

        .core-description {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-style: italic;
        }

        .detailed-operators {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .operator-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .operator-item:hover {
            transform: translateX(4px);
        }

        .shares .operator-item:hover { border-color: var(--blue); }
        .okays .operator-item:hover { border-color: var(--purple); }
        .does .operator-item:hover { border-color: var(--green); }

        .operator-name {
            font-weight: 600;
            text-transform: capitalize;
            margin-bottom: 4px;
        }

        .operator-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Flows Section */
        .flows-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid var(--border);
        }

        .flows-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .flows-header h3 {
            font-size: 1.5rem;
            font-weight: 300;
        }

        .flow-type-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 4px;
        }

        .flow-type-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .flow-type-btn.active {
            background: var(--bg);
            color: var(--text);
        }

        .toggle-view {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 4px;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background: var(--bg);
            color: var(--text);
        }

        .flows-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .flow-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            transition: all 0.2s ease;
        }

        .flow-item:hover {
            border-color: var(--green);
        }

        .flow-item.shares-flow { border-left: 4px solid var(--blue); }
        .flow-item.okays-flow { border-left: 4px solid var(--purple); }
        .flow-item.does-flow { border-left: 4px solid var(--green); }

        .flow-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .flow-role {
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 6px;
            font-weight: 600;
            white-space: nowrap;
        }

        .flow-arrow {
            color: var(--text-dim);
            font-size: 1.2rem;
        }

        .flow-operator {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            white-space: nowrap;
        }

        .shares-flow .flow-operator {
            background: rgba(0, 221, 255, 0.1);
            border: 1px solid var(--blue);
            color: var(--blue);
        }

        .okays-flow .flow-operator {
            background: rgba(153, 69, 255, 0.1);
            border: 1px solid var(--purple);
            color: var(--purple);
        }

        .does-flow .flow-operator {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--green);
            color: var(--green);
        }

        .flow-operand {
            flex: 1;
            font-style: italic;
            color: var(--text-dim);
        }

        .flow-meta {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flow-timestamp {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .flow-consent {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .consent-status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .consent-status.approved {
            background: rgba(0, 255, 136, 0.1);
            color: var(--green);
        }

        .consent-status.pending {
            background: rgba(255, 170, 0, 0.1);
            color: var(--yellow);
        }

        .consent-status.rejected {
            background: rgba(255, 51, 102, 0.1);
            color: var(--red);
        }

        .consent-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .consent-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--green);
            border-radius: 4px;
            color: var(--green);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .consent-btn:hover {
            background: var(--green);
            color: var(--bg);
        }

        .consent-btn.reject {
            border-color: var(--red);
            color: var(--red);
        }

        .consent-btn.reject:hover {
            background: var(--red);
            color: var(--bg);
        }

        .flow-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .flow-item:hover .flow-actions {
            opacity: 1;
        }

        .flow-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .flow-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        .add-flow-btn {
            margin-top: 20px;
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-flow-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        /* Tasks System - Enhanced Kanban */
        .tasks-section {
            padding: 20px 0;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .tasks-header h2 {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .tasks-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .task-filter {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
        }

        .task-view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            border-radius: 6px;
            padding: 4px;
        }

        .task-view-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .task-view-btn.active {
            background: var(--bg);
            color: var(--green);
        }

        /* Kanban Board View */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .kanban-column {
            flex: 0 0 280px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 70vh;
        }

        .kanban-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-title {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .kanban-count {
            padding: 2px 8px;
            background: var(--bg);
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .kanban-cards {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .kanban-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: move;
            transition: all 0.2s ease;
            position: relative;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .kanban-card.dragging {
            opacity: 0.5;
        }

        .kanban-card.drag-over {
            border-color: var(--green);
            background: rgba(0, 255, 136, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .card-id {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-family: monospace;
        }

        .card-priority {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .card-priority.urgent {
            background: var(--red);
            animation: pulse-priority 2s ease-in-out infinite;
        }

        .card-priority.high {
            background: var(--yellow);
        }

        .card-priority.normal {
            background: var(--green);
        }

        .card-priority.low {
            background: var(--text-dim);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .card-flow {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .card-flow-indicator {
            width: 4px;
            height: 12px;
            border-radius: 2px;
        }

        .card-flow-indicator.shares { background: var(--blue); }
        .card-flow-indicator.does { background: var(--green); }
        .card-flow-indicator.okays { background: var(--purple); }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .card-tag {
            padding: 2px 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .card-tag.urgent {
            background: rgba(255, 51, 102, 0.1);
            border-color: var(--red);
            color: var(--red);
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .card-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assignee-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), var(--blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            color: var(--bg);
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .card-due {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .due-overdue {
            color: var(--red);
        }

        .card-comments {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* Quick Add Task */
        .quick-task-form {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: none;
        }

        .quick-task-form.active {
            display: block;
        }

        .quick-task-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text);
            margin-bottom: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 0 0 0 rgba(0, 255, 136, 0.15);
        }

        .quick-task-input:focus {
            outline: none;
            background: rgba(0, 255, 136, 0.02);
            border-color: var(--green);
            box-shadow: 0 0 0 1px var(--green), 0 0 18px rgba(0, 255, 136, 0.1);
        }

        .quick-task-tags {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .tag-selector {
            padding: 4px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tag-selector:hover {
            border-color: var(--green);
        }

        .tag-selector.selected {
            background: var(--green);
            color: var(--bg);
            border-color: var(--green);
        }

        .quick-task-actions {
            display: flex;
            gap: 8px;
        }

        .quick-task-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .quick-task-save {
            background: var(--green);
            color: var(--bg);
        }

        .quick-task-cancel {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
        }

        /* Task Detail Modal */
        .task-detail-modal {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 480px;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }

        .task-detail-modal.active {
            transform: translateX(0);
        }

        .task-detail-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .task-detail-body {
            padding: 24px;
        }

        .task-section {
            margin-bottom: 24px;
        }

        .task-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .task-description {
            padding: 12px;
            background: var(--bg);
            border-radius: 6px;
            min-height: 100px;
        }

        .task-activity {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
        }

        .activity-time {
            color: var(--text-dim);
            min-width: 60px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-user {
            font-weight: 600;
        }

        /* Flow-Task List */
        .flow-task-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .flow-task-group {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .flow-task-group.collapsed .flow-task-content {
            display: none;
        }

        .flow-task-header {
            padding: 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .flow-task-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .flow-task-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flow-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .flow-expand-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .flow-task-group.collapsed .flow-expand-icon {
            transform: rotate(-90deg);
        }

        .flow-path {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .flow-path .role {
            padding: 6px 12px;
            background: var(--bg);
            border-radius: 6px;
            font-weight: 600;
        }

        .flow-path .operator {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .shares-operator {
            background: rgba(0, 221, 255, 0.1);
            border: 1px solid var(--blue);
            color: var(--blue);
        }

        .does-operator {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--green);
            color: var(--green);
        }

        .okays-operator {
            background: rgba(153, 69, 255, 0.1);
            border: 1px solid var(--purple);
            color: var(--purple);
        }

        .flow-stats {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flow-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .stat-label {
            color: var(--text-dim);
        }

        .stat-value {
            font-weight: 600;
        }

        .create-task-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--green);
            border-radius: 6px;
            color: var(--green);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .create-task-btn:hover {
            background: var(--green);
            color: var(--bg);
        }

        /* Task Content Area */
        .flow-task-content {
            padding: 20px;
        }

        .task-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .task-column {
            min-height: 100px;
        }

        .task-column-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .task-column-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .task-card.shares-task {
            border-left: 3px solid var(--blue);
        }

        .task-card.does-task {
            border-left: 3px solid var(--green);
        }

        .task-card.okays-task {
            border-left: 3px solid var(--purple);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .task-id {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-family: monospace;
        }

        .task-priority {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .task-priority.high {
            background: var(--red);
            animation: pulse-priority 2s ease-in-out infinite;
        }

        @keyframes pulse-priority {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .task-priority.medium {
            background: var(--yellow);
        }

        .task-priority.low {
            background: var(--green);
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .task-chain-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chain-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--green);
        }

        .chain-line {
            width: 12px;
            height: 1px;
            background: var(--green);
        }

        .chain-count {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            color: var(--green);
        }

        .task-assignee {
            font-size: 0.75rem;
            padding: 2px 6px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            color: var(--green);
        }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* People Section */
        .people-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid var(--border);
        }

        .people-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .person-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .person-card:hover {
            border-color: var(--green);
            transform: translateY(-2px);
        }

        .person-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), var(--blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--bg);
        }

        .person-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .person-role-count {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Network Tab - Pod Connections */
        .network-section {
            padding: 20px 0;
        }

        .network-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .network-header h2 {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .pod-selector {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .current-pod-label {
            padding: 8px 16px;
            background: var(--green);
            color: var(--bg);
            border-radius: 6px;
            font-weight: 600;
        }

        .connected-pods {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
        }

        .pod-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            transition: all 0.2s ease;
        }

        .pod-card:hover {
            border-color: var(--green);
            transform: translateY(-2px);
        }

        .pod-card.current {
            border-color: var(--green);
            background: rgba(0, 255, 136, 0.05);
        }

        .pod-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .pod-name {
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pod-health {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 4px;
        }

        .health-value {
            color: var(--green);
            font-weight: 600;
        }

        .pod-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .pod-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
        }

        .pod-stat-value {
            font-weight: 600;
        }

        .pod-stat-label {
            color: var(--text-dim);
        }

        .pod-flows {
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .pod-flow-count {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .pod-flow-indicators {
            display: flex;
            gap: 8px;
        }

        .flow-indicator {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
        }

        .flow-indicator.shares { background: var(--blue); }
        .flow-indicator.does { background: var(--green); }
        .flow-indicator.okays { background: var(--purple); }

        .add-pod-btn {
            width: 100%;
            padding: 40px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-pod-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        .add-pod-icon {
            font-size: 2rem;
            opacity: 0.5;
        }

        .pod-flows-list {
            margin-top: 40px;
        }

        .pod-flow-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pod-flow-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .pod-badge {
            padding: 6px 12px;
            background: var(--bg);
            border: 2px solid var(--green);
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .pod-flow-item.shares-flow .flow-operator {
            background: rgba(0, 221, 255, 0.1);
            border: 1px solid var(--blue);
            color: var(--blue);
        }

        .pod-flow-item.okays-flow .flow-operator {
            background: rgba(153, 69, 255, 0.1);
            border: 1px solid var(--purple);
            color: var(--purple);
        }

        .pod-flow-item.does-flow .flow-operator {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--green);
            color: var(--green);
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 0 0 0 rgba(0, 255, 136, 0.1);
        }

        .login-input:focus {
            outline: none;
            background: rgba(0, 255, 136, 0.02);
            border-color: var(--green);
            box-shadow: 0 0 0 1px var(--green), 0 0 20px rgba(0, 255, 136, 0.12);
        }

        .login-btn {
            padding: 14px;
            background: var(--green);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* Profile Header */
        .profile-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .profile-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), var(--blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--bg);
            font-size: 1.2rem;
        }

        .profile-details {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .profile-pods {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .pod-switcher {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pod-switcher-label {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .pod-selector-dropdown {
            position: relative;
        }

        .pod-selector-trigger {
            padding: 8px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
        }

        .pod-selector-trigger:hover {
            border-color: var(--green);
        }

        .current-pod-name {
            flex: 1;
            font-weight: 600;
        }

        .pod-selector-arrow {
            width: 8px;
            height: 8px;
            border-right: 2px solid var(--text-dim);
            border-bottom: 2px solid var(--text-dim);
            transform: rotate(45deg);
            transition: transform 0.2s ease;
        }

        .pod-selector-trigger.active .pod-selector-arrow {
            transform: rotate(-135deg);
            margin-top: 2px;
        }

        .pod-selector-options {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            z-index: 1000;
            display: none;
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .pod-selector-options.active {
            display: block;
        }

        .pod-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pod-option:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--green);
            padding-left: 20px;
        }

        .pod-option.selected {
            background: rgba(0, 255, 136, 0.1);
            border-left-color: var(--green);
        }

        .pod-option-name {
            font-weight: 600;
        }

        .pod-option-role {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .pod-option-health {
            font-size: 0.85rem;
            color: var(--green);
        }

        .pod-selector-divider {
            border-top: 1px solid var(--border);
            margin: 4px 0;
        }

        .create-pod-option {
            color: var(--text-dim);
            font-style: italic;
        }

        .create-pod-option:hover {
            color: var(--text);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
        }

        .profile-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .profile-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        .profile-btn.logout {
            color: var(--red);
            border-color: var(--red);
        }

        .profile-btn.logout:hover {
            background: var(--red);
            color: var(--bg);
        }

        /* Profile Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .profile-modal.active {
            display: flex;
        }

        .profile-modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 32px;
        }

        .profile-modal-title {
            font-size: 1.5rem;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 16px;
        }

        .pod-membership-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pod-membership-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pod-membership-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pod-membership-name {
            font-weight: 600;
        }

        .pod-membership-roles {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 2px 8px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--green);
        }

        .pod-membership-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Main App Wrapper */
        .app-container {
            display: none;
        }

        .app-container.logged-in {
            display: block;
        }

        .login-screen {
            display: block;
        }

        .login-screen.hidden {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .flow-builder {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 92px;
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-dim);
            transition: all 0.3s ease;
        }

        .progress-step .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            color: var(--green);
        }

        .progress-step.active .step-number {
            border-color: var(--green);
            color: var(--green);
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.25);
        }

        .progress-step.completed {
            color: var(--green);
        }

        .progress-step.completed .step-number {
            background: var(--green);
            color: var(--bg);
            border-color: var(--green);
        }

        .progress-line {
            flex: 1;
            height: 1px;
            background: var(--border);
            position: relative;
            overflow: hidden;
        }

        .progress-line::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.45));
            transition: width 0.3s ease;
        }

        .progress-line.active::after {
            width: 50%;
        }

        .progress-line.completed::after {
            width: 100%;
        }

        .flow-preview {
            margin-top: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            overflow: hidden;
        }

        .flow-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.4), transparent);
            opacity: 0.7;
        }

        .flow-preview.ready {
            border-color: var(--green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.18);
        }

        .flow-preview.is-empty .preview-content {
            opacity: 0.6;
        }

        .preview-label {
            font-size: 0.65rem;
            letter-spacing: 3px;
            color: var(--text-dim);
            margin-bottom: 8px;
            display: block;
        }

        .preview-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preview-role {
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .preview-operator {
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            text-transform: lowercase;
        }

        .preview-operator.shares {
            color: var(--blue);
            box-shadow: 0 0 12px rgba(0, 221, 255, 0.25);
        }

        .preview-operator.okays {
            color: var(--purple);
            box-shadow: 0 0 12px rgba(153, 69, 255, 0.25);
        }

        .preview-operator.does {
            color: var(--green);
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.25);
        }

        .preview-operand {
            font-style: italic;
            color: var(--text-dim);
        }

        .preview-arrow {
            opacity: 0.6;
        }

        .suggestions-panel {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-pill {
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .suggestion-pill:hover {
            color: var(--text);
            border-color: var(--green);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.18);
        }

        .suggestion-placeholder {
            font-size: 0.75rem;
            color: var(--text-dim);
            opacity: 0.7;
        }

        .builder-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .builder-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .label-required {
            color: var(--red);
            font-size: 0.85rem;
            margin-left: 4px;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-helper {
            font-size: 0.7rem;
            color: var(--text-dim);
            opacity: 0.7;
        }

        .input-error {
            display: none;
            font-size: 0.7rem;
            color: var(--red);
        }

        .input-error.active {
            display: block;
            animation: shake 0.3s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom Select Dropdown */
        .custom-select {
            position: relative;
            width: 100%;
        }

        .select-trigger {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 0 0 0 rgba(0, 255, 136, 0.1);
        }

        .select-trigger:hover {
            border-color: rgba(0, 255, 136, 0.35);
        }

        .select-trigger.active {
            border-color: var(--green);
            box-shadow: 0 0 0 1px var(--green), 0 0 18px rgba(0, 255, 136, 0.12);
            background: rgba(0, 255, 136, 0.02);
        }

        .select-trigger:focus-visible {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 1px var(--green), 0 0 18px rgba(0, 255, 136, 0.12);
        }

        .custom-select.error .select-trigger {
            border-color: var(--red);
            box-shadow: 0 0 0 1px rgba(255, 51, 102, 0.5);
            background: rgba(255, 51, 102, 0.02);
        }

        .custom-select.error .select-arrow {
            border-right-color: var(--red);
            border-bottom-color: var(--red);
        }

        .select-arrow {
            width: 12px;
            height: 12px;
            border-right: 2px solid var(--text-dim);
            border-bottom: 2px solid var(--text-dim);
            transform: rotate(45deg);
            transition: transform 0.2s ease;
            margin-top: -4px;
        }

        .select-trigger.active .select-arrow {
            transform: rotate(-135deg);
            margin-top: 2px;
        }

        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .select-options.active {
            display: block;
        }

        .select-option {
            position: relative;
            padding: 12px 16px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.25s ease;
            border-left: 3px solid transparent;
            overflow: hidden;
        }

        .select-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.12));
            transform: translateY(-50%);
            transition: width 0.3s ease;
        }

        .select-option:hover::before,
        .select-option.highlight::before {
            width: 100%;
        }

        .select-option:hover {
            border-left-color: var(--green);
            padding-left: 20px;
        }

        .select-option.selected {
            background: rgba(0, 255, 136, 0.12);
            color: var(--green);
            border-left-color: var(--green);
        }

        .select-option.selected::after {
            content: '';
            position: absolute;
            right: 16px;
            font-weight: bold;
            color: var(--green);
        }

        .select-option.highlight {
            color: var(--green);
        }

        .builder-select,
        .builder-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 0 0 0 rgba(0, 255, 136, 0.1);
        }

        .builder-input:hover {
            border-color: rgba(0, 255, 136, 0.35);
        }

        .builder-input:focus {
            outline: none;
            background: rgba(0, 255, 136, 0.02);
            border-color: var(--green);
            box-shadow: 0 0 0 1px var(--green), 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .builder-input:invalid,
        .builder-input.error {
            border-color: var(--red);
            background: rgba(255, 51, 102, 0.02);
            box-shadow: 0 0 0 1px rgba(255, 51, 102, 0.5);
        }

        .builder-input::placeholder {
            color: var(--text-dim);
        }

        .operator-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .operator-grid.error {
            border: 1px solid rgba(255, 51, 102, 0.5);
            border-radius: 12px;
            padding: 6px;
        }

        .operator-option {
            position: relative;
            padding: 14px;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .operator-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.06));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .operator-option:hover::before {
            transform: translateX(0);
        }

        .operator-option:hover {
            border-color: var(--green);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.18);
        }

        .operator-option.selected {
            transform: scale(1.05);
            z-index: 1;
            border-color: var(--green);
            box-shadow: 0 6px 18px rgba(0, 255, 136, 0.3);
        }

        .operator-option.shares { border-color: rgba(0, 221, 255, 0.5); }
        .operator-option.okays { border-color: rgba(153, 69, 255, 0.5); }
        .operator-option.does { border-color: rgba(0, 255, 136, 0.6); }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn-primary {
            background: var(--green);
            color: var(--bg);
            position: relative;
            overflow: hidden;
        }

        .modal-btn-primary.loading {
            color: transparent;
            pointer-events: none;
        }

        .modal-btn-primary.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid var(--bg);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .modal-btn-cancel {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--border);
        }

        .form-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--green);
            color: var(--bg);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .app-container:not(.logged-in) .form-fab {
            display: none;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .task-columns {
                grid-template-columns: 1fr;
            }
            
            .role.icon-view {
                width: calc(50% - 8px);
            }
            
            .triads {
                gap: 8px;
            }
        }

        @media (max-width: 600px) {
            .pod-stats {
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .role.icon-view {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1 class="login-title">CRISIS COMMONS</h1>
                    <p class="login-subtitle">Emergency Response Coordination</p>
                </div>
                <div class="login-form">
                    <input type="text" class="login-input" id="usernameInput" placeholder="Username" value="demo">
                    <input type="password" class="login-input" id="passwordInput" placeholder="Password" value="1234">
                    <button class="login-btn" onclick="login()">Enter System</button>
                </div>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); text-align: center;">
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 12px;">Quick Access:</p>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="quickLogin('demo')" style="padding: 4px 8px; background: var(--green); border: none; border-radius: 4px; color: var(--bg); font-size: 0.75rem; cursor: pointer; font-weight: 600;">Demo Account</button>
                        <button onclick="quickLogin('CrystalSparrow')" style="padding: 4px 8px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-dim); font-size: 0.75rem; cursor: pointer;">CrystalSparrow</button>
                        <button onclick="quickLogin('SilverFox')" style="padding: 4px 8px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-dim); font-size: 0.75rem; cursor: pointer;">SilverFox</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2 class="profile-modal-title">User Profile</h2>
                <button class="modal-close-btn" onclick="closeProfile()"></button>
            </div>
            
            <div class="profile-section">
                <div class="profile-section-title">USER INFORMATION</div>
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 16px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--green), var(--blue)); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; color: var(--bg);" id="profileAvatar">C</div>
                    <div>
                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 4px;" id="profileName">CrystalSparrow</div>
                        <div style="color: var(--text-dim); font-size: 0.9rem;" id="profileEmail">crystal.sparrow@crisis.commons</div>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-section-title">POD MEMBERSHIPS</div>
                <div class="pod-membership-list" id="podMembershipList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-section-title">ACTIVITY SUMMARY</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--green);" id="taskCount">12</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 4px;">Active Tasks</div>
                    </div>
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--blue);" id="flowCount">8</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 4px;">Active Flows</div>
                    </div>
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--purple);" id="roleCount">3</div>
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 4px;">Roles Held</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-container">
                <div class="profile-info">
                    <div class="profile-avatar" id="userAvatar">C</div>
                    <div class="profile-details">
                        <div class="profile-name" id="userName">CrystalSparrow</div>
                        <div class="profile-pods" id="userPodCount">Member of 3 pods</div>
                    </div>
                </div>
                
                <div class="pod-switcher">
                    <span class="pod-switcher-label">Current Pod:</span>
                    <div class="pod-selector-dropdown">
                        <div class="pod-selector-trigger" onclick="togglePodSelector()">
                            <span class="current-pod-name" id="currentPodDisplay">NORTHSIDE RESPONSE</span>
                            <span class="pod-selector-arrow"></span>
                        </div>
                        <div class="pod-selector-options" id="podSelectorOptions">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="profile-btn" onclick="showProfile()">Profile</button>
                    <button class="profile-btn logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Pod Interface -->
        <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="pod-title">NORTHSIDE RESPONSE</h1>
            <div class="pod-stats">
                <div class="stat">
                    <span class="stat-value">87%</span>
                    <span class="stat-label">Health</span>
                </div>
                <div class="stat">
                    <span class="stat-value">7/9</span>
                    <span class="stat-label">Roles Filled</span>
                </div>
                <div class="stat">
                    <span class="stat-value">12</span>
                    <span class="stat-label">Active Flows</span>
                </div>
                <div class="stat">
                    <span class="stat-value">12</span>
                    <span class="stat-label">People</span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('roles', this)">Roles</button>
            <button class="nav-tab" onclick="switchTab('flows', this)">Flows</button>
            <button class="nav-tab" onclick="switchTab('tasks', this)">Tasks</button>
            <button class="nav-tab" onclick="switchTab('people', this)">People</button>
            <button class="nav-tab" onclick="switchTab('network', this)">Network</button>
        </div>

        <!-- Roles Tab -->
        <div class="tab-content active" id="rolesTab">
            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-btn active" onclick="toggleRoleView('icon')">Icon View</button>
                <button class="view-btn" onclick="toggleRoleView('table')">Table View</button>
            </div>

            <div class="triads" id="triadsContainer">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Flows Tab -->
        <div class="tab-content" id="flowsTab">
            <div class="operator-model">
                <!-- SHARES -->
                <div class="core-operator shares">
                    <div class="core-header">
                        <div class="core-title">SHARES</div>
                        <div class="core-description">Make it visible</div>
                    </div>
                    <div class="detailed-operators">
                        <div class="operator-item" onclick="selectOperator('spot', 'shares')">
                            <div class="operator-name">Spot</div>
                            <div class="operator-desc">Notice gaps, risks, missing pieces</div>
                        </div>
                        <div class="operator-item" onclick="selectOperator('define', 'shares')">
                            <div class="operator-name">Define</div>
                            <div class="operator-desc">Create shared language & standards</div>
                        </div>
                        <div class="operator-item" onclick="selectOperator('bound', 'shares')">
                            <div class="operator-name">Bound</div>
                            <div class="operator-desc">Set scope and access (in/out)</div>
                        </div>
                        <div class="operator-item" onclick="selectOperator('reflect', 'shares')">
                            <div class="operator-name">Reflect</div>
                            <div class="operator-desc">Capture what happened, share lessons</div>
                        </div>
                    </div>
                </div>

                <!-- OKAYS -->
                <div class="core-operator okays">
                    <div class="core-header">
                        <div class="core-title">OKAYS</div>
                        <div class="core-description">Check, align & ratchet</div>
                    </div>
                    <div class="detailed-operators">
                        <div class="operator-item" onclick="selectOperator('integrate', 'okays')">
                            <div class="operator-name">Integrate</div>
                            <div class="operator-desc">Align overlapping efforts</div>
                        </div>
                        <div class="operator-item" onclick="selectOperator('pace', 'okays')">
                            <div class="operator-name">Pace</div>
                            <div class="operator-desc">Keep timing sustainable & in sync</div>
                        </div>
                    </div>
                </div>

                <!-- DOES -->
                <div class="core-operator does">
                    <div class="core-header">
                        <div class="core-title">DOES</div>
                        <div class="core-description">Do the work</div>
                    </div>
                    <div class="detailed-operators">
                        <div class="operator-item" onclick="selectOperator('build', 'does')">
                            <div class="operator-name">Build</div>
                            <div class="operator-desc">Create tools, kits, prototypes</div>
                        </div>
                        <div class="operator-item" onclick="selectOperator('connect', 'does')">
                            <div class="operator-name">Connect</div>
                            <div class="operator-desc">Link people, flows & resources</div>
                        </div>
                        <div class="operator-item" onclick="selectOperator('protect', 'does')">
                            <div class="operator-name">Protect</div>
                            <div class="operator-desc">Add backups & resilience</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flows List -->
            <div class="flows-section">
                <div class="flows-header">
                    <h3>Active Process Flows</h3>
                    <div class="toggle-view">
                        <button class="toggle-btn active" onclick="setView('simple')">Simple (3)</button>
                        <button class="toggle-btn" onclick="setView('detailed')">Detailed (9)</button>
                    </div>
                </div>

                <button class="add-flow-btn" onclick="openFlowBuilder()">+ Create New Flow</button>

                <div class="flows-list" id="flowsList">
                    <!-- Generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-content" id="tasksTab">
            <div class="tasks-section">
                <div class="tasks-header">
                    <h2>Tasks</h2>
                    <div class="tasks-controls">
                        <select class="task-filter" id="taskFilter" onchange="filterTasks()">
                            <option value="all">All Tasks</option>
                            <option value="my-tasks">My Tasks</option>
                            <option value="urgent">Urgent</option>
                            <option value="blocked">Blocked</option>
                        </select>
                        <div class="task-view-toggle">
                            <button class="task-view-btn active" onclick="setTaskView('kanban')">Board</button>
                            <button class="task-view-btn" onclick="setTaskView('flow')">By Flow</button>
                        </div>
                    </div>
                </div>

                <!-- Kanban Board View -->
                <div id="kanbanView" class="kanban-board">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Flow-grouped view -->
                <div id="flowView" class="flow-task-list" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Task Detail Sidebar -->
        <div class="task-detail-modal" id="taskDetailModal">
            <div class="task-detail-header">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="task-id" id="detailTaskId">#T001</div>
                        <h2 id="detailTaskTitle">Task Title</h2>
                    </div>
                    <button onclick="closeTaskDetail()" style="background: none; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer;"></button>
                </div>
            </div>
            <div class="task-detail-body">
                <div class="task-section">
                    <div class="task-section-title">DETAILS</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-dim);">Status:</span>
                            <select id="detailStatus" onchange="updateTaskStatus()" style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                                <option value="backlog">Backlog</option>
                                <option value="ready">Ready</option>
                                <option value="in-progress">In Progress</option>
                                <option value="blocked">Blocked</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-dim);">Priority:</span>
                            <select id="detailPriority" onchange="updateTaskPriority()" style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                                <option value="low">Low</option>
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-dim);">Assignee:</span>
                            <span id="detailAssignee">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-dim);">Flow:</span>
                            <span id="detailFlow" style="font-size: 0.85rem;">-</span>
                        </div>
                    </div>
                </div>

                <div class="task-section">
                    <div class="task-section-title">DESCRIPTION</div>
                    <div class="task-description" id="detailDescription" contenteditable="true">
                        Task description...
                    </div>
                </div>

                <div class="task-section">
                    <div class="task-section-title">TAGS</div>
                    <div class="card-tags" id="detailTags">
                        <!-- Tags will be populated here -->
                    </div>
                    <button onclick="addTag()" style="margin-top: 8px; padding: 4px 8px; background: transparent; border: 1px dashed var(--border); border-radius: 4px; color: var(--text-dim); font-size: 0.75rem; cursor: pointer;">+ Add Tag</button>
                </div>

                <div class="task-section">
                    <div class="task-section-title">ACTIVITY LOG</div>
                    <div class="task-activity" id="detailActivity">
                        <!-- Activity will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- People Tab -->
        <div class="tab-content" id="peopleTab">
            <div class="people-section">
                <div class="people-header">
                    <h2>People in Pod</h2>
                    <p style="color: var(--text-dim);">12 members total</p>
                </div>
                <div class="people-grid" id="peopleGrid">
                    <!-- Generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Network Tab -->
        <div class="tab-content" id="networkTab">
            <div class="network-section">
                <div class="network-header">
                    <h2>Pod Network</h2>
                    <div class="pod-selector">
                        <span style="color: var(--text-dim);">Current Pod:</span>
                        <span class="current-pod-label">NORTHSIDE RESPONSE</span>
                    </div>
                </div>

                <h3 style="margin-bottom: 20px; font-weight: 300;">Connected Pods</h3>
                <div class="connected-pods" id="connectedPods">
                    <!-- Will be populated by JavaScript -->
                </div>

                <h3 style="margin: 40px 0 20px; font-weight: 300;">Inter-Pod Flows</h3>
                <div class="flows-header">
                    <div>Active connections between pods</div>
                    <div class="flow-type-toggle">
                        <button class="flow-type-btn active" onclick="setFlowType('all')">All Flows</button>
                        <button class="flow-type-btn" onclick="setFlowType('incoming')">Incoming</button>
                        <button class="flow-type-btn" onclick="setFlowType('outgoing')">Outgoing</button>
                    </div>
                </div>

                <button class="add-flow-btn" onclick="openPodFlowBuilder()">+ Create Pod Connection</button>

                <div class="pod-flows-list" id="podFlowsList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        <button type="button" class="form-fab" id="openFlowFab" aria-label="Create new flow" title="Create new flow">+</button>
    </div>

    <!-- Flow Builder Modal -->
    <div class="modal" id="flowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Process Flow</h3>
                <p style="color: var(--text-dim);">Define how roles interact through operators</p>
            </div>

            <div class="form-progress" id="flowProgress">
                <div class="progress-step active" data-step="source">
                    <span class="step-number">1</span>
                    <span class="step-label">Source</span>
                </div>
                <div class="progress-line" data-line="source"></div>
                <div class="progress-step" data-step="action">
                    <span class="step-number">2</span>
                    <span class="step-label">Action</span>
                </div>
                <div class="progress-line" data-line="action"></div>
                <div class="progress-step" data-step="target">
                    <span class="step-number">3</span>
                    <span class="step-label">Target</span>
                </div>
            </div>

            <div class="flow-builder">
                <div class="builder-row" data-step="source">
                    <label class="builder-label">From Role<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="custom-select" id="fromRoleSelect">
                            <div class="select-trigger" role="button" tabindex="0" onclick="toggleDropdown('fromRole')" onkeydown="handleDropdownKeyboard(event, 'fromRole')">
                                <span class="select-value" data-value="">Select role...</span>
                                <span class="select-arrow"></span>
                            </div>
                            <div class="select-options" id="fromRoleOptions">
                                <div class="select-option" onclick="selectOption('fromRole', 'Starter', event)">Starter</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Definer', event)">Definer</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Builder', event)">Builder</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Divider', event)">Divider</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Connector', event)">Connector</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Integrator', event)">Integrator</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Balancer', event)">Balancer</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Overlayer', event)">Overlayer</div>
                                <div class="select-option" onclick="selectOption('fromRole', 'Reflector', event)">Reflector</div>
                            </div>
                        </div>
                        <span class="input-helper">Select the initiating role for this flow</span>
                        <span class="input-error" id="fromRoleError">Select a source role</span>
                    </div>
                </div>

                <div class="builder-row" data-step="action">
                    <label class="builder-label">Core Operator Category<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="operator-grid" id="coreOperatorGrid">
                            <div class="operator-option shares" data-core="shares" onclick="selectCoreCategory('shares')">
                                <div style="font-weight: bold;">SHARES</div>
                                <div style="font-size: 0.7rem; margin-top: 4px;">Make visible</div>
                            </div>
                            <div class="operator-option does" data-core="does" onclick="selectCoreCategory('does')">
                                <div style="font-weight: bold;">DOES</div>
                                <div style="font-size: 0.7rem; margin-top: 4px;">Do the work</div>
                            </div>
                            <div class="operator-option okays" data-core="okays" onclick="selectCoreCategory('okays')">
                                <div style="font-weight: bold;">OKAYS</div>
                                <div style="font-size: 0.7rem; margin-top: 4px;">Align & ratchet</div>
                            </div>
                        </div>
                        <span class="input-helper">Choose the utilitarian mode of action</span>
                        <span class="input-error" id="operatorError">Select a core operator</span>
                    </div>
                </div>

                <div class="builder-row" id="detailedOperatorRow" style="display: none;">
                    <label class="builder-label">Specific Operator (Optional)</label>
                    <div class="input-wrapper">
                        <div class="operator-grid" id="operatorGrid">
                            <!-- Will be dynamically populated based on selected core category -->
                        </div>
                        <span class="input-helper">Refine the action with a detailed operator (optional)</span>
                    </div>
                </div>

                <div class="builder-row" data-step="action">
                    <label class="builder-label">What (Operand)<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <input type="text" class="builder-input" id="operand" placeholder="e.g., emerging risks, resource needs, sprint cycles..." data-validate="required" required>
                        <span class="input-helper">Describe what is being acted upon</span>
                        <span class="input-error" id="operandError">This field is required</span>
                    </div>
                </div>

                <div class="builder-row">
                    <label class="builder-label">Preposition</label>
                    <div class="input-wrapper">
                        <div class="custom-select" id="prepositionSelect">
                            <div class="select-trigger" role="button" tabindex="0" onclick="toggleDropdown('preposition')" onkeydown="handleDropdownKeyboard(event, 'preposition')">
                                <span class="select-value" data-value="to">to</span>
                                <span class="select-arrow"></span>
                            </div>
                            <div class="select-options" id="prepositionOptions">
                                <div class="select-option selected" onclick="selectOption('preposition', 'to', event)">to</div>
                                <div class="select-option" onclick="selectOption('preposition', 'with', event)">with</div>
                                <div class="select-option" onclick="selectOption('preposition', 'through', event)">through</div>
                                <div class="select-option" onclick="selectOption('preposition', 'for', event)">for</div>
                                <div class="select-option" onclick="selectOption('preposition', 'from', event)">from</div>
                                <div class="select-option" onclick="selectOption('preposition', 'by', event)">by</div>
                            </div>
                        </div>
                        <span class="input-helper">Define how the action connects the roles</span>
                    </div>
                </div>

                <div class="builder-row" data-step="target">
                    <label class="builder-label">To Role<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="custom-select" id="toRoleSelect">
                            <div class="select-trigger" role="button" tabindex="0" onclick="toggleDropdown('toRole')" onkeydown="handleDropdownKeyboard(event, 'toRole')">
                                <span class="select-value" data-value="">Select role...</span>
                                <span class="select-arrow"></span>
                            </div>
                            <div class="select-options" id="toRoleOptions">
                                <div class="select-option" onclick="selectOption('toRole', 'Starter', event)">Starter</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Definer', event)">Definer</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Builder', event)">Builder</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Divider', event)">Divider</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Connector', event)">Connector</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Integrator', event)">Integrator</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Balancer', event)">Balancer</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Overlayer', event)">Overlayer</div>
                                <div class="select-option" onclick="selectOption('toRole', 'Reflector', event)">Reflector</div>
                            </div>
                        </div>
                        <span class="input-helper">Select the receiving role for this flow</span>
                        <span class="input-error" id="toRoleError">Select a destination role</span>
                    </div>
                </div>
            </div>

            <div class="flow-preview is-empty" id="flowPreview">
                <span class="preview-label">PREVIEW</span>
                <div class="preview-content">
                    <span class="preview-role from" id="previewFrom">Source Role</span>
                    <span class="preview-arrow"></span>
                    <span class="preview-operator" id="previewOperator">operator</span>
                    <span class="preview-operand" id="previewOperand"></span>
                    <span class="preview-arrow" id="previewPreposition">to</span>
                    <span class="preview-role to" id="previewTo">Target Role</span>
                </div>
            </div>

            <div class="suggestions-panel" id="flowSuggestions">
                <div class="suggestion-placeholder">Start configuring the flow to see smart suggestions.</div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-primary" onclick="createFlow()">Create Flow</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Pod Flow Builder Modal -->
    <div class="modal" id="podFlowModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Pod Connection</h3>
                <p style="color: var(--text-dim);">Connect pods using the same flow grammar</p>
            </div>

            <div class="flow-builder">
                <div class="builder-row">
                    <label class="builder-label">Connection Type</label>
                    <div class="input-wrapper">
                        <div class="operator-grid" id="podConnectionGrid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="operator-option" data-type="role-to-role" onclick="setPodFlowType('role-to-role')">
                                <div style="font-weight: bold;">Role  Role</div>
                                <div style="font-size: 0.7rem; margin-top: 4px;">Cross-pod role flow</div>
                            </div>
                            <div class="operator-option" data-type="pod-to-role" onclick="setPodFlowType('pod-to-role')">
                                <div style="font-weight: bold;">Pod  Role</div>
                                <div style="font-size: 0.7rem; margin-top: 4px;">Pod-level to role</div>
                            </div>
                            <div class="operator-option selected" data-type="pod-to-pod" onclick="setPodFlowType('pod-to-pod')">
                                <div style="font-weight: bold;">Pod  Pod</div>
                                <div style="font-size: 0.7rem; margin-top: 4px;">Pod-level flow</div>
                            </div>
                        </div>
                        <span class="input-helper">Choose the scope of the inter-pod connection</span>
                    </div>
                </div>

                <div class="builder-row" id="podFromRow">
                    <label class="builder-label">From</label>
                    <div class="input-wrapper">
                        <input type="text" class="builder-input" id="podFrom" value="NORTHSIDE RESPONSE" readonly style="background: rgba(0, 255, 136, 0.05);">
                        <span class="input-helper">Origin pod for this connection</span>
                    </div>
                </div>

                <div class="builder-row" id="podFromRoleRow" style="display: none;">
                    <label class="builder-label">From Role (in NORTHSIDE)<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="custom-select" id="podFromRoleSelect">
                            <div class="select-trigger" role="button" tabindex="0" onclick="toggleDropdown('podFromRole')" onkeydown="handleDropdownKeyboard(event, 'podFromRole')">
                                <span class="select-value" data-value="">Select role...</span>
                                <span class="select-arrow"></span>
                            </div>
                            <div class="select-options" id="podFromRoleOptions">
                                <div class="select-option" onclick="selectOption('podFromRole', 'Starter', event)">Starter</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Definer', event)">Definer</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Builder', event)">Builder</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Divider', event)">Divider</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Connector', event)">Connector</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Integrator', event)">Integrator</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Balancer', event)">Balancer</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Overlayer', event)">Overlayer</div>
                                <div class="select-option" onclick="selectOption('podFromRole', 'Reflector', event)">Reflector</div>
                            </div>
                        </div>
                        <span class="input-helper">Specify the initiating role within the origin pod</span>
                        <span class="input-error" id="podFromRoleError">Select a source role</span>
                    </div>
                </div>

                <div class="builder-row">
                    <label class="builder-label">Core Operator<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="operator-grid" id="podCoreOperatorGrid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="operator-option shares" data-core="shares" onclick="selectPodCoreCategory('shares')">
                                <div style="font-weight: bold;">SHARES</div>
                            </div>
                            <div class="operator-option does" data-core="does" onclick="selectPodCoreCategory('does')">
                                <div style="font-weight: bold;">DOES</div>
                            </div>
                            <div class="operator-option okays" data-core="okays" onclick="selectPodCoreCategory('okays')">
                                <div style="font-weight: bold;">OKAYS</div>
                            </div>
                        </div>
                        <span class="input-helper">Select the operational intent for this connection</span>
                        <span class="input-error" id="podCoreError">Select a core operator</span>
                    </div>
                </div>

                <div class="builder-row">
                    <label class="builder-label">What (Operand)<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <input type="text" class="builder-input" id="podOperand" placeholder="e.g., regional patterns, shared resources, coordination..." data-validate="required" required>
                        <span class="input-helper">Describe what is moving between pods</span>
                        <span class="input-error" id="podOperandError">Provide an operand</span>
                    </div>
                </div>

                <div class="builder-row">
                    <label class="builder-label">To Pod<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="custom-select" id="toPodSelect">
                            <div class="select-trigger" role="button" tabindex="0" onclick="toggleDropdown('toPod')" onkeydown="handleDropdownKeyboard(event, 'toPod')">
                                <span class="select-value" data-value="">Select pod...</span>
                                <span class="select-arrow"></span>
                            </div>
                            <div class="select-options" id="toPodOptions">
                                <div class="select-option" onclick="selectOption('toPod', 'SOUTH DISTRICT', event)">SOUTH DISTRICT</div>
                                <div class="select-option" onclick="selectOption('toPod', 'CENTRAL COMMAND', event)">CENTRAL COMMAND</div>
                                <div class="select-option" onclick="selectOption('toPod', 'MEDICAL SECTOR', event)">MEDICAL SECTOR</div>
                                <div class="select-option" onclick="selectOption('toPod', '[New Pod]', event)">[New Pod]</div>
                            </div>
                        </div>
                        <span class="input-helper">Choose the receiving pod</span>
                        <span class="input-error" id="toPodError">Select a destination pod</span>
                    </div>
                </div>

                <div class="builder-row" id="podToRoleRow" style="display: none;">
                    <label class="builder-label">To Role (in target pod)<span class="label-required">*</span></label>
                    <div class="input-wrapper">
                        <div class="custom-select" id="podToRoleSelect">
                            <div class="select-trigger" role="button" tabindex="0" onclick="toggleDropdown('podToRole')" onkeydown="handleDropdownKeyboard(event, 'podToRole')">
                                <span class="select-value" data-value="">Select role...</span>
                                <span class="select-arrow"></span>
                            </div>
                            <div class="select-options" id="podToRoleOptions">
                                <div class="select-option" onclick="selectOption('podToRole', 'Starter', event)">Starter</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Definer', event)">Definer</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Builder', event)">Builder</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Divider', event)">Divider</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Connector', event)">Connector</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Integrator', event)">Integrator</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Balancer', event)">Balancer</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Overlayer', event)">Overlayer</div>
                                <div class="select-option" onclick="selectOption('podToRole', 'Reflector', event)">Reflector</div>
                            </div>
                        </div>
                        <span class="input-helper">Identify the receiving role inside the target pod</span>
                        <span class="input-error" id="podToRoleError">Select a receiving role</span>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-primary" onclick="createPodFlow()">Create Connection</button>
                <button class="modal-btn modal-btn-cancel" onclick="closePodModal()">Cancel</button>
            </div>
        </div>
    </div>
    <script>
        // State
        let currentUser = null;
        let currentPodIndex = 0;
        let currentTab = 'roles';
        let viewMode = 'simple';
        let roleViewMode = 'icon';
        let expandedTriads = new Set(['creation', 'structure', 'continuity']); // Start expanded
        let selectedOperator = null;
        let selectedCategory = null;
        let selectedCoreCategory = null;
        let expandedFlows = new Set();
        let podFlowType = 'pod-to-pod';
        let selectedPodCoreCategory = null;
        let flowTypeFilter = 'all';
        let currentTaskView = 'kanban';
        let selectedTask = null;
        let taskFilter = 'all';
        let draggedTask = null;
        let selectedTags = [];

        // User database
        const users = {
            'demo': {
                name: 'DemoUser',
                email: 'demo@crisis.commons',
                password: '1234',
                pods: [
                    { name: 'NORTHSIDE RESPONSE', roles: ['Definer', 'Builder'] },
                    { name: 'CENTRAL COMMAND', roles: ['Connector'] }
                ]
            },
            'CrystalSparrow': {
                name: 'CrystalSparrow',
                email: 'crystal.sparrow@crisis.commons',
                password: '1234',
                pods: [
                    { name: 'NORTHSIDE RESPONSE', roles: ['Definer'] },
                    { name: 'CENTRAL COMMAND', roles: ['Overlayer'] },
                    { name: 'MEDICAL SECTOR', roles: ['Connector'] }
                ]
            },
            'SilverFox': {
                name: 'SilverFox',
                email: 'silver.fox@crisis.commons',
                password: '1234',
                pods: [
                    { name: 'NORTHSIDE RESPONSE', roles: ['Starter'] },
                    { name: 'SOUTH DISTRICT', roles: ['Starter', 'Reflector'] }
                ]
            },
            'RedWolf': {
                name: 'RedWolf',
                email: 'red.wolf@crisis.commons',
                password: '1234',
                pods: [
                    { name: 'NORTHSIDE RESPONSE', roles: ['Divider'] },
                    { name: 'CENTRAL COMMAND', roles: ['Balancer'] }
                ]
            },
            'BlueWolf': {
                name: 'BlueWolf',
                email: 'blue.wolf@crisis.commons',
                password: '1234',
                pods: [
                    { name: 'NORTHSIDE RESPONSE', roles: ['Balancer'] }
                ]
            },
            'GoldenFox': {
                name: 'GoldenFox',
                email: 'golden.fox@crisis.commons',
                password: '1234',
                pods: [
                    { name: 'NORTHSIDE RESPONSE', roles: ['Connector'] },
                    { name: 'MEDICAL SECTOR', roles: ['Integrator'] }
                ]
            }
        };

        // Pod database
        const podsDatabase = {
            'NORTHSIDE RESPONSE': {
                name: 'NORTHSIDE RESPONSE',
                health: 87,
                rolesFilled: 7,
                totalRoles: 9,
                activeFlows: 12,
                people: 12
            },
            'SOUTH DISTRICT': {
                name: 'SOUTH DISTRICT',
                health: 92,
                rolesFilled: 8,
                totalRoles: 9,
                activeFlows: 8,
                people: 10
            },
            'CENTRAL COMMAND': {
                name: 'CENTRAL COMMAND',
                health: 95,
                rolesFilled: 9,
                totalRoles: 9,
                activeFlows: 15,
                people: 15
            },
            'MEDICAL SECTOR': {
                name: 'MEDICAL SECTOR',
                health: 78,
                rolesFilled: 6,
                totalRoles: 9,
                activeFlows: 10,
                people: 8
            }
        };

        // Current pod info (will be updated based on selected pod)
        let currentPod = podsDatabase['NORTHSIDE RESPONSE'];

        // Connected pods data (will be filtered based on current pod)
        let connectedPods = [];

        // Pod-to-pod flows
        const podFlows = [
            {
                type: 'pod-to-pod',
                from: 'NORTHSIDE RESPONSE',
                fromRole: null,
                operator: 'shares',
                operand: 'regional risk patterns',
                to: 'CENTRAL COMMAND',
                toRole: null,
                category: 'shares',
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                consent: { from: 'approved', to: 'approved' }
            },
            {
                type: 'role-to-role',
                from: 'NORTHSIDE RESPONSE',
                fromRole: 'Connector',
                operator: 'connect',
                operand: 'medical resources',
                to: 'MEDICAL SECTOR',
                toRole: 'Builder',
                category: 'does',
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                consent: { from: 'approved', to: 'approved' }
            },
            {
                type: 'pod-to-role',
                from: 'CENTRAL COMMAND',
                fromRole: null,
                operator: 'okays',
                operand: 'resource allocation',
                to: 'NORTHSIDE RESPONSE',
                toRole: 'Balancer',
                category: 'okays',
                timestamp: new Date(Date.now() - 1800000).toISOString(),
                consent: { from: 'approved', to: 'pending' }
            }
        ];

        // Data
        const triadsData = [
            {
                id: 'creation',
                title: 'CREATION',
                description: 'Beginning Phase',
                roles: [
                    { name: 'Starter', icon: '', description: 'Spots gaps, raises alarm', people: ['SilverFox'] },
                    { name: 'Definer', icon: '', description: 'Sets success criteria', people: ['CrystalSparrow'] },
                    { name: 'Builder', icon: '', description: 'Makes it real', people: ['ShadowSparrow', 'RedMaple'] }
                ]
            },
            {
                id: 'structure',
                title: 'STRUCTURE',
                description: 'Cohesion Phase',
                roles: [
                    { name: 'Divider', icon: '', description: 'Protects boundaries', people: ['RedWolf'] },
                    { name: 'Connector', icon: '', description: 'Links people & resources', people: ['GoldenFox'] },
                    { name: 'Integrator', icon: '', description: 'Weaves pieces together', people: ['BlueSparrow'] }
                ]
            },
            {
                id: 'continuity',
                title: 'CONTINUITY',
                description: 'Sustainability Phase',
                roles: [
                    { name: 'Balancer', icon: '', description: 'Manages pace', people: ['BlueWolf'] },
                    { name: 'Overlayer', icon: '', description: 'Sees systems', people: [] },
                    { name: 'Reflector', icon: '', description: 'Captures lessons', people: [] }
                ]
            }
        ];

        const people = [
            { name: 'SilverFox', roles: ['Starter'] },
            { name: 'CrystalSparrow', roles: ['Definer'] },
            { name: 'ShadowSparrow', roles: ['Builder'] },
            { name: 'RedMaple', roles: ['Builder'] },
            { name: 'RedWolf', roles: ['Divider'] },
            { name: 'GoldenFox', roles: ['Connector'] },
            { name: 'BlueSparrow', roles: ['Integrator'] },
            { name: 'BlueWolf', roles: ['Balancer'] },
            { name: 'GreenOwl', roles: [] },
            { name: 'SilverEagle', roles: [] },
            { name: 'CrystalBear', roles: [] },
            { name: 'ShadowFox', roles: [] }
        ];

        const flows = [
            { 
                from: 'Starter', 
                operator: 'spot', 
                operand: 'emerging risks', 
                preposition: 'to', 
                to: 'Definer', 
                category: 'shares',
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                consent: { from: 'approved', to: 'approved' }
            },
            { 
                from: 'Definer', 
                operator: 'define', 
                operand: 'success criteria', 
                preposition: 'for', 
                to: 'Builder', 
                category: 'shares',
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                consent: { from: 'approved', to: 'pending' }
            },
            { 
                from: 'Builder', 
                operator: 'build', 
                operand: 'intake system', 
                preposition: 'with', 
                to: 'Connector', 
                category: 'does',
                timestamp: new Date(Date.now() - 1800000).toISOString(),
                consent: { from: 'approved', to: 'approved' }
            },
            { 
                from: 'Connector', 
                operator: 'connect', 
                operand: 'resource providers', 
                preposition: 'to', 
                to: 'Builder', 
                category: 'does',
                timestamp: new Date(Date.now() - 900000).toISOString(),
                consent: { from: 'pending', to: 'pending' }
            },
            { 
                from: 'Balancer', 
                operator: 'pace', 
                operand: 'sprint cycles', 
                preposition: 'for', 
                to: 'Builder', 
                category: 'okays',
                timestamp: new Date(Date.now() - 86400000).toISOString(),
                consent: { from: 'approved', to: 'approved' }
            }
        ];

        const tasks = [
            {
                id: 'T001',
                flowId: 0,
                title: 'Critical infrastructure risk identified',
                description: 'Power grid vulnerability detected in sector 7',
                from: 'Starter',
                to: 'Definer',
                operator: 'spot',
                category: 'shares',
                status: 'in-progress',
                priority: 'urgent',
                assignee: 'CrystalSparrow',
                tags: ['infrastructure', 'critical'],
                dueDate: new Date(Date.now() + 86400000).toISOString(),
                created: new Date(Date.now() - 3600000).toISOString(),
                activity: [
                    { time: '1h ago', user: 'SilverFox', action: 'created task' },
                    { time: '45m ago', user: 'CrystalSparrow', action: 'changed status to In Progress' },
                    { time: '30m ago', user: 'CrystalSparrow', action: 'added tag: critical' }
                ]
            },
            {
                id: 'T002',
                flowId: 1,
                title: 'Define response criteria',
                description: 'Need clear success metrics for infrastructure protection',
                from: 'Definer',
                to: 'Builder',
                operator: 'define',
                category: 'shares',
                status: 'ready',
                priority: 'high',
                assignee: 'ShadowSparrow',
                tags: ['planning'],
                dueDate: new Date(Date.now() + 172800000).toISOString(),
                created: new Date(Date.now() - 1800000).toISOString(),
                activity: [
                    { time: '30m ago', user: 'CrystalSparrow', action: 'created task' }
                ]
            },
            {
                id: 'T003',
                flowId: 2,
                title: 'Build emergency response system',
                description: 'Construct failsafe for identified vulnerability',
                from: 'Builder',
                to: 'Connector',
                operator: 'build',
                category: 'does',
                status: 'backlog',
                priority: 'high',
                assignee: null,
                tags: ['build', 'emergency'],
                dueDate: null,
                created: new Date(Date.now() - 900000).toISOString(),
                activity: [
                    { time: '15m ago', user: 'ShadowSparrow', action: 'created task' }
                ]
            },
            {
                id: 'T004',
                flowId: 3,
                title: 'Connect emergency teams',
                description: 'Link first responders with command center',
                from: 'Connector',
                to: 'Builder',
                operator: 'connect',
                category: 'does',
                status: 'blocked',
                priority: 'normal',
                assignee: 'GoldenFox',
                tags: ['coordination', 'blocked'],
                dueDate: new Date(Date.now() + 259200000).toISOString(),
                created: new Date(Date.now() - 7200000).toISOString(),
                activity: [
                    { time: '2h ago', user: 'GoldenFox', action: 'created task' },
                    { time: '1h ago', user: 'GoldenFox', action: 'changed status to Blocked' },
                    { time: '1h ago', user: 'GoldenFox', action: 'added comment: Waiting for communication equipment' }
                ]
            },
            {
                id: 'T005',
                flowId: 0,
                title: 'Monitor water supply systems',
                description: 'Check for contamination risks',
                from: 'Starter',
                to: 'Definer',
                operator: 'spot',
                category: 'shares',
                status: 'done',
                priority: 'normal',
                assignee: 'SilverFox',
                tags: ['water', 'monitoring'],
                dueDate: new Date(Date.now() - 86400000).toISOString(),
                created: new Date(Date.now() - 259200000).toISOString(),
                activity: [
                    { time: '3d ago', user: 'SilverFox', action: 'created task' },
                    { time: '2d ago', user: 'SilverFox', action: 'changed status to Done' }
                ]
            }
        ];

        const categoryMap = {
            'shares': ['spot', 'define', 'bound', 'reflect'],
            'okays': ['integrate', 'pace'],
            'does': ['build', 'connect', 'protect']
        };

        const commonFlows = [
            { from: 'Starter', operator: 'spot', operand: 'emerging risks', preposition: 'to', to: 'Definer' },
            { from: 'Builder', operator: 'build', operand: 'response systems', preposition: 'for', to: 'Connector' },
            { from: 'Connector', operator: 'connect', operand: 'mutual aid teams', preposition: 'to', to: 'Builder' },
            { from: 'Definer', operator: 'define', operand: 'deployment protocols', preposition: 'for', to: 'Integrator' },
            { from: 'Reflector', operator: 'reflect', operand: 'lessons learned', preposition: 'with', to: 'Starter' }
        ];

        // Custom dropdown functionality
        let selectedValues = {
            fromRole: '',
            preposition: 'to',
            toRole: ''
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in (in real app, would check session)
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = users[savedUser];
                if (currentUser) {
                    enterApp();
                }
            }
        });

        // Login functions
        function login() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                localStorage.setItem('currentUser', username);
                enterApp();
            } else {
                alert('Invalid username or password');
            }
        }

        function quickLogin(username) {
            document.getElementById('usernameInput').value = username;
            document.getElementById('passwordInput').value = '1234';
            login();
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('logged-in');
        }

        function enterApp() {
            // Hide login, show app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('logged-in');
            
            // Update profile header
            updateProfileHeader();
            
            // Set initial pod
            if (currentUser.pods.length > 0) {
                switchPod(currentUser.pods[0].name);
            }
            
            // Render initial view
            renderRoles();
        }

        function updateProfileHeader() {
            if (!currentUser) return;
            
            // Update avatar
            document.getElementById('userAvatar').textContent = currentUser.name[0];
            
            // Update name and pod count
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userPodCount').textContent = `Member of ${currentUser.pods.length} pod${currentUser.pods.length !== 1 ? 's' : ''}`;
            
            // Update pod selector options
            const podOptions = document.getElementById('podSelectorOptions');
            podOptions.innerHTML = currentUser.pods.map((pod, index) => `
                <div class="pod-option ${index === currentPodIndex ? 'selected' : ''}" onclick="switchPod('${pod.name}')">
                    <div>
                        <div class="pod-option-name">${pod.name}</div>
                        <div class="pod-option-role">${pod.roles.join(', ')}</div>
                    </div>
                    <div class="pod-option-health">${podsDatabase[pod.name]?.health || 75}%</div>
                </div>
            `).join('') + `
                <div class="pod-selector-divider"></div>
                <div class="pod-option create-pod-option" onclick="createNewPod()">
                    <div class="pod-option-name">+ Join or Create Pod</div>
                </div>
            `;
        }

        function togglePodSelector() {
            const trigger = document.querySelector('.pod-selector-trigger');
            const options = document.getElementById('podSelectorOptions');
            
            trigger.classList.toggle('active');
            options.classList.toggle('active');
            
            // Close on outside click
            if (trigger.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', function closePodSelector(e) {
                        if (!trigger.contains(e.target) && !options.contains(e.target)) {
                            trigger.classList.remove('active');
                            options.classList.remove('active');
                            document.removeEventListener('click', closePodSelector);
                        }
                    });
                }, 100);
            }
        }

        function switchPod(podName) {
            // Find pod index
            const podIndex = currentUser.pods.findIndex(p => p.name === podName);
            if (podIndex === -1) return;
            
            currentPodIndex = podIndex;
            currentPod = podsDatabase[podName] || {
                name: podName,
                health: 75,
                rolesFilled: 0,
                totalRoles: 9,
                activeFlows: 0,
                people: 1
            };
            
            // Update display
            document.getElementById('currentPodDisplay').textContent = podName;
            document.querySelector('.pod-title').textContent = podName;
            
            // Update pod stats
            document.querySelector('.stat-value').textContent = currentPod.health + '%';
            document.querySelectorAll('.stat-value')[1].textContent = `${currentPod.rolesFilled}/${currentPod.totalRoles}`;
            document.querySelectorAll('.stat-value')[2].textContent = currentPod.activeFlows;
            document.querySelectorAll('.stat-value')[3].textContent = currentPod.people;
            
            // Update connected pods (exclude current pod)
            connectedPods = Object.values(podsDatabase)
                .filter(pod => pod.name !== podName)
                .map(pod => ({
                    ...pod,
                    flowTypes: { shares: 3, does: 2, okays: 1 } // Mock data
                }));
            
            // Close selector
            document.querySelector('.pod-selector-trigger').classList.remove('active');
            document.getElementById('podSelectorOptions').classList.remove('active');
            
            // Update profile header
            updateProfileHeader();
            
            // Re-render current tab
            if (currentTab === 'network') {
                renderNetwork();
            } else if (currentTab === 'roles') {
                renderRoles();
            }
        }

        function createNewPod() {
            const podName = prompt('Enter new pod name:');
            if (podName) {
                // Add to user's pods
                currentUser.pods.push({
                    name: podName,
                    roles: ['Starter'] // Default role
                });
                
                // Add to database
                podsDatabase[podName] = {
                    name: podName,
                    health: 75,
                    rolesFilled: 1,
                    totalRoles: 9,
                    activeFlows: 0,
                    people: 1
                };
                
                // Switch to new pod
                switchPod(podName);
            }
        }

        // Profile modal functions
        function showProfile() {
            document.getElementById('profileModal').classList.add('active');
            
            // Update profile info
            document.getElementById('profileAvatar').textContent = currentUser.name[0];
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            
            // Update pod memberships
            const membershipList = document.getElementById('podMembershipList');
            membershipList.innerHTML = currentUser.pods.map(pod => {
                const podData = podsDatabase[pod.name];
                return `
                    <div class="pod-membership-item">
                        <div class="pod-membership-info">
                            <div class="pod-membership-name">${pod.name}</div>
                            <div class="pod-membership-roles">
                                ${pod.roles.map(role => `
                                    <span class="role-badge">${role}</span>
                                `).join('')}
                            </div>
                        </div>
                        <div class="pod-membership-meta">
                            <span>${podData?.health || 75}% health</span>
                            <span>${podData?.people || 1} members</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update activity stats
            const myTasks = tasks.filter(t => t.assignee === currentUser.name).length;
            const myFlows = flows.filter(f => 
                triadsData.some(triad => 
                    triad.roles.some(role => 
                        role.name === f.from && role.people.includes(currentUser.name)
                    )
                )
            ).length;
            const myRoles = currentUser.pods.reduce((acc, pod) => acc + pod.roles.length, 0);
            
            document.getElementById('taskCount').textContent = myTasks;
            document.getElementById('flowCount').textContent = myFlows;
            document.getElementById('roleCount').textContent = myRoles;
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.remove('active');
        }

        // Tab switching
        function switchTab(tab, element) {
            currentTab = tab;
            
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabContent = document.getElementById(tab + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (tab === 'people') {
                renderPeople();
            } else if (tab === 'flows') {
                renderFlows();
            } else if (tab === 'tasks') {
                renderTasks();
            } else if (tab === 'roles') {
                renderRoles();
            } else if (tab === 'network') {
                renderNetwork();
            }
        }

        // Toggle role view between icon and table
        function toggleRoleView(mode) {
            roleViewMode = mode;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderRoles();
        }

        // Toggle triad collapse/expand
        function toggleTriad(triadId) {
            if (expandedTriads.has(triadId)) {
                expandedTriads.delete(triadId);
            } else {
                expandedTriads.add(triadId);
            }
            renderRoles();
        }

        // Render roles based on view mode
        function renderRoles() {
            const container = document.getElementById('triadsContainer');
            if (!container) return;
            
            if (roleViewMode === 'icon') {
                renderIconView(container);
            } else {
                renderTableView(container);
            }
        }

        // Render Icon View
        function renderIconView(container) {
            container.innerHTML = triadsData.map(triad => {
                const isExpanded = expandedTriads.has(triad.id);
                const filledCount = triad.roles.filter(r => r.people.length > 0).length;
                
                return `
                    <div class="triad ${isExpanded ? '' : 'collapsed'}">
                        <div class="triad-header" onclick="toggleTriad('${triad.id}')">
                            <div class="triad-info">
                                <span class="collapse-icon"></span>
                                <div>
                                    <div class="triad-title">${triad.title}</div>
                                    <div class="triad-description">${triad.description}</div>
                                </div>
                            </div>
                            <div class="triad-summary">
                                ${triad.roles.map(role => `
                                    <div class="role-indicator ${role.people.length > 0 ? 'filled' : 'empty'}"></div>
                                `).join('')}
                                <div class="triad-status">${filledCount}/${triad.roles.length} filled</div>
                            </div>
                        </div>
                        <div class="roles-content">
                            <div class="roles icon-view">
                                ${triad.roles.map(role => `
                                    <div class="role icon-view ${role.people.length > 0 ? 'filled' : 'empty'}" onclick="quickAdd('${role.name}')">
                                        <div class="role-compact">
                                            <div class="role-icon">${role.icon}</div>
                                            <div class="role-name">${role.name}</div>
                                            <div class="role-description" style="font-size: 0.75rem; color: var(--text-dim);">${role.description}</div>
                                            <div class="role-people-count ${role.people.length === 0 ? 'empty' : ''}">
                                                ${role.people.length > 0 ? `${role.people.length} person${role.people.length > 1 ? 's' : ''}` : 'Empty'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Table View
        function renderTableView(container) {
            container.innerHTML = triadsData.map(triad => {
                const isExpanded = expandedTriads.has(triad.id);
                const filledCount = triad.roles.filter(r => r.people.length > 0).length;
                
                return `
                    <div class="triad ${isExpanded ? '' : 'collapsed'}">
                        <div class="triad-header" onclick="toggleTriad('${triad.id}')">
                            <div class="triad-info">
                                <span class="collapse-icon"></span>
                                <div>
                                    <div class="triad-title">${triad.title}</div>
                                    <div class="triad-description">${triad.description}</div>
                                </div>
                            </div>
                            <div class="triad-summary">
                                ${triad.roles.map(role => `
                                    <div class="role-indicator ${role.people.length > 0 ? 'filled' : 'empty'}"></div>
                                `).join('')}
                                <div class="triad-status">${filledCount}/${triad.roles.length} filled</div>
                            </div>
                        </div>
                        <div class="roles-content">
                            <div class="roles table-view">
                                <table class="role-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Role</th>
                                            <th>Description</th>
                                            <th>People</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${triad.roles.map(role => `
                                            <tr>
                                                <td>
                                                    <div class="status-dot ${role.people.length > 0 ? 'filled' : 'empty'}"></div>
                                                </td>
                                                <td>
                                                    <div class="role-cell">
                                                        <span>${role.icon}</span>
                                                        <span style="font-weight: 600;">${role.name}</span>
                                                    </div>
                                                </td>
                                                <td style="color: var(--text-dim); font-size: 0.85rem;">
                                                    ${role.description}
                                                </td>
                                                <td>
                                                    <div class="people-tags">
                                                        ${role.people.length > 0 ? 
                                                            role.people.map((person, idx) => `
                                                                <span class="person-tag ${idx > 0 ? 'backup' : ''}">${person}</span>
                                                            `).join('') :
                                                            '<span class="empty-tag">Empty - Critical!</span>'
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="add-btn" onclick="quickAdd('${role.name}')">+ Add</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // People rendering
        function renderPeople() {
            const grid = document.getElementById('peopleGrid');
            if (!grid) return;
            
            grid.innerHTML = people.map(person => `
                <div class="person-card">
                    <div class="person-avatar">${person.name[0]}</div>
                    <div class="person-name">${person.name}</div>
                    <div class="person-role-count">${person.roles.length} role${person.roles.length !== 1 ? 's' : ''}</div>
                </div>
            `).join('');
        }

        // Flow rendering
        function getCoreOperator(operator) {
            for (const [core, ops] of Object.entries(categoryMap)) {
                if (ops.includes(operator)) return core;
            }
            return 'shares';
        }

        function renderFlows() {
            const list = document.getElementById('flowsList');
            if (!list) return;
            
            let displayFlows = flows.map(f => {
                let displayOperator = f.operator;
                if (viewMode === 'simple') {
                    displayOperator = f.category;
                }
                
                return {
                    ...f,
                    displayOperator: displayOperator
                };
            });

            list.innerHTML = displayFlows.map((flow, index) => {
                const timeAgo = getTimeAgo(flow.timestamp);
                const consentStatus = getConsentStatus(flow.consent);
                const needsConsent = flow.consent.from === 'pending' || flow.consent.to === 'pending';
                
                return `
                <div class="flow-item ${flow.category}-flow">
                    <div class="flow-content">
                        <div class="flow-role">${flow.from}</div>
                        <span class="flow-arrow"></span>
                        <div class="flow-operator">${flow.displayOperator}</div>
                        <div class="flow-operand">"${flow.operand}"</div>
                        <span class="flow-arrow">${flow.preposition}</span>
                        <div class="flow-role">${flow.to}</div>
                    </div>
                    <div class="flow-meta">
                        <div class="flow-timestamp">${timeAgo}</div>
                        <div class="flow-consent">
                            <div class="consent-status ${consentStatus.class}">
                                <span class="consent-dot"></span>
                                ${consentStatus.text}
                            </div>
                            ${needsConsent ? `
                                <button class="consent-btn" onclick="approveFlow(${index})">Approve</button>
                                <button class="consent-btn reject" onclick="rejectFlow(${index})">Reject</button>
                            ` : ''}
                        </div>
                        <div class="flow-actions">
                            <button class="flow-btn" onclick="editFlow(${index})">Edit</button>
                            <button class="flow-btn" onclick="deleteFlow(${index})">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes} min ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            return `${days} day${days !== 1 ? 's' : ''} ago`;
        }

        function getConsentStatus(consent) {
            if (consent.from === 'approved' && consent.to === 'approved') {
                return { text: 'Active', class: 'approved' };
            } else if (consent.from === 'rejected' || consent.to === 'rejected') {
                return { text: 'Rejected', class: 'rejected' };
            } else {
                return { text: 'Pending', class: 'pending' };
            }
        }

        function approveFlow(index) {
            const flow = flows[index];
            if (flow.consent.from === 'pending') {
                flow.consent.from = 'approved';
            }
            if (flow.consent.to === 'pending') {
                flow.consent.to = 'approved';
            }
            renderFlows();
        }

        function rejectFlow(index) {
            const flow = flows[index];
            flow.consent.from = 'rejected';
            renderFlows();
        }

        function setView(mode) {
            viewMode = mode;
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderFlows();
        }

        // Tasks rendering
        function renderTasks() {
            if (currentTaskView === 'kanban') {
                renderKanbanBoard();
            } else {
                renderFlowTasks();
            }
        }

        function setTaskView(view) {
            currentTaskView = view;
            document.querySelectorAll('.task-view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (view === 'kanban') {
                document.getElementById('kanbanView').style.display = 'flex';
                document.getElementById('flowView').style.display = 'none';
                renderKanbanBoard();
            } else {
                document.getElementById('kanbanView').style.display = 'none';
                document.getElementById('flowView').style.display = 'block';
                renderFlowTasks();
            }
        }

        function renderKanbanBoard() {
            const board = document.getElementById('kanbanView');
            if (!board) return;
            
            const columns = ['backlog', 'ready', 'in-progress', 'blocked', 'done'];
            const columnTitles = {
                'backlog': 'Backlog',
                'ready': 'Ready',
                'in-progress': 'In Progress',
                'blocked': 'Blocked',
                'done': 'Done'
            };
            
            let filteredTasks = tasks;
            if (taskFilter === 'my-tasks') {
                // In real app, would filter by current user
                filteredTasks = tasks.filter(t => t.assignee === 'CrystalSparrow');
            } else if (taskFilter === 'urgent') {
                filteredTasks = tasks.filter(t => t.priority === 'urgent');
            } else if (taskFilter === 'blocked') {
                filteredTasks = tasks.filter(t => t.status === 'blocked');
            }
            
            board.innerHTML = columns.map(column => {
                const columnTasks = filteredTasks.filter(t => t.status === column);
                
                return `
                    <div class="kanban-column" data-column="${column}">
                        <div class="kanban-header">
                            <div class="kanban-title">${columnTitles[column]}</div>
                            <div class="kanban-count">${columnTasks.length}</div>
                        </div>
                        <div class="kanban-cards" ondrop="handleDrop(event, '${column}')" ondragover="handleDragOver(event)">
                            ${column === 'backlog' ? `
                                <div class="quick-task-form" id="quickTaskForm">
                                    <input type="text" class="quick-task-input" placeholder="Task title..." id="quickTaskTitle">
                                    <div class="quick-task-tags">
                                        <span class="tag-selector" data-tag="urgent" onclick="toggleTag(this)">urgent</span>
                                        <span class="tag-selector" data-tag="infrastructure" onclick="toggleTag(this)">infrastructure</span>
                                        <span class="tag-selector" data-tag="coordination" onclick="toggleTag(this)">coordination</span>
                                    </div>
                                    <div class="quick-task-actions">
                                        <button class="quick-task-btn quick-task-save" onclick="saveQuickTask()">Add</button>
                                        <button class="quick-task-btn quick-task-cancel" onclick="cancelQuickTask()">Cancel</button>
                                    </div>
                                </div>
                                <button onclick="showQuickTaskForm()" style="width: 100%; padding: 8px; background: transparent; border: 1px dashed var(--border); border-radius: 4px; color: var(--text-dim); cursor: pointer;">
                                    + Add Task
                                </button>
                            ` : ''}
                            ${columnTasks.map(task => renderKanbanCard(task)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderKanbanCard(task) {
            const isOverdue = task.dueDate && new Date(task.dueDate) < new Date();
            const daysUntilDue = task.dueDate ? Math.ceil((new Date(task.dueDate) - new Date()) / 86400000) : null;
            
            return `
                <div class="kanban-card" 
                     draggable="true" 
                     ondragstart="handleDragStart(event, '${task.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="showTaskDetail('${task.id}')">
                    <div class="card-header">
                        <span class="card-id">#${task.id}</span>
                        <span class="card-priority ${task.priority}"></span>
                    </div>
                    <div class="card-title">${task.title}</div>
                    <div class="card-flow">
                        <span class="card-flow-indicator ${task.category}"></span>
                        <span>${task.from}  ${task.operator}  ${task.to}</span>
                    </div>
                    ${task.tags.length > 0 ? `
                        <div class="card-tags">
                            ${task.tags.map(tag => `
                                <span class="card-tag ${tag === 'urgent' ? 'urgent' : ''}">${tag}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="card-footer">
                        <div class="card-assignee">
                            ${task.assignee ? `
                                <span class="assignee-avatar">${task.assignee[0]}</span>
                                <span style="font-size: 0.75rem;">${task.assignee}</span>
                            ` : '<span style="font-size: 0.75rem; color: var(--text-dim);">Unassigned</span>'}
                        </div>
                        <div class="card-meta">
                            ${task.dueDate ? `
                                <span class="card-due ${isOverdue ? 'due-overdue' : ''}">
                                    ${isOverdue ? 'Overdue' : `${daysUntilDue}d`}
                                </span>
                            ` : ''}
                            ${task.activity.length > 0 ? `
                                <span class="card-comments"> ${task.activity.length}</span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFlowTasks() {
            const list = document.getElementById('flowView');
            if (!list) return;
            
            const tasksByFlow = {};
            flows.forEach((flow, index) => {
                const flowKey = `flow-${index}`;
                tasksByFlow[flowKey] = {
                    flow: flow,
                    tasks: tasks.filter(t => t.flowId === index)
                };
            });
            
            list.innerHTML = Object.entries(tasksByFlow).map(([flowKey, data]) => {
                const isExpanded = expandedFlows.has(flowKey);
                
                return `
                    <div class="flow-task-group ${isExpanded ? '' : 'collapsed'}" data-flow="${flowKey}">
                        <div class="flow-task-header" onclick="toggleFlowTasks('${flowKey}')">
                            <div class="flow-task-header-content">
                                <div class="flow-info">
                                    <span class="flow-expand-icon"></span>
                                    <div class="flow-path">
                                        <span class="role">${data.flow.from}</span>
                                        <span></span>
                                        <span class="operator ${data.flow.category}-operator">${data.flow.operator}</span>
                                        <span class="flow-operand" style="color: var(--text-dim); font-style: italic;">
                                            "${data.flow.operand}"
                                        </span>
                                        <span></span>
                                        <span class="role">${data.flow.to}</span>
                                    </div>
                                </div>
                                <div class="flow-stats">
                                    <div class="flow-stat">
                                        <span class="stat-value">${data.tasks.length}</span>
                                        <span class="stat-label">tasks</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flow-task-content">
                            ${data.tasks.length > 0 ? `
                                <div style="display: flex; flex-direction: column; gap: 8px; padding: 16px;">
                                    ${data.tasks.map(task => renderKanbanCard(task)).join('')}
                                </div>
                            ` : `
                                <div class="empty-state">
                                    <div class="empty-state-icon"></div>
                                    <div>No tasks in this flow</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Drag and Drop
        function handleDragStart(e, taskId) {
            draggedTask = tasks.find(t => t.id === taskId);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e, column) {
            e.preventDefault();
            if (draggedTask) {
                const oldStatus = draggedTask.status;
                draggedTask.status = column;
                draggedTask.activity.unshift({
                    time: 'now',
                    user: 'You',
                    action: `moved from ${oldStatus} to ${column}`
                });
                renderKanbanBoard();
                draggedTask = null;
            }
        }

        // Quick Task Form
        function showQuickTaskForm() {
            document.getElementById('quickTaskForm').classList.add('active');
            document.getElementById('quickTaskTitle').focus();
        }

        function cancelQuickTask() {
            document.getElementById('quickTaskForm').classList.remove('active');
            document.getElementById('quickTaskTitle').value = '';
            selectedTags = [];
            document.querySelectorAll('.tag-selector').forEach(tag => {
                tag.classList.remove('selected');
            });
        }

        function toggleTag(element) {
            const tag = element.dataset.tag;
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
                element.classList.remove('selected');
            } else {
                selectedTags.push(tag);
                element.classList.add('selected');
            }
        }

        function saveQuickTask() {
            const title = document.getElementById('quickTaskTitle').value;
            if (!title) return;
            
            const newTask = {
                id: `T${String(tasks.length + 1).padStart(3, '0')}`,
                flowId: 0,
                title: title,
                description: '',
                from: 'Starter',
                to: 'Definer',
                operator: 'spot',
                category: 'shares',
                status: 'backlog',
                priority: selectedTags.includes('urgent') ? 'urgent' : 'normal',
                assignee: null,
                tags: selectedTags,
                dueDate: null,
                created: new Date().toISOString(),
                activity: [
                    { time: 'now', user: 'You', action: 'created task' }
                ]
            };
            
            tasks.unshift(newTask);
            cancelQuickTask();
            renderKanbanBoard();
        }

        // Task Detail Modal
        function showTaskDetail(taskId) {
            selectedTask = tasks.find(t => t.id === taskId);
            if (!selectedTask) return;
            
            document.getElementById('taskDetailModal').classList.add('active');
            document.getElementById('detailTaskId').textContent = `#${selectedTask.id}`;
            document.getElementById('detailTaskTitle').textContent = selectedTask.title;
            document.getElementById('detailStatus').value = selectedTask.status;
            document.getElementById('detailPriority').value = selectedTask.priority;
            document.getElementById('detailAssignee').textContent = selectedTask.assignee || 'Unassigned';
            document.getElementById('detailFlow').textContent = `${selectedTask.from}  ${selectedTask.operator}  ${selectedTask.to}`;
            document.getElementById('detailDescription').textContent = selectedTask.description;
            
            // Render tags
            const tagsContainer = document.getElementById('detailTags');
            tagsContainer.innerHTML = selectedTask.tags.map(tag => `
                <span class="card-tag">${tag}</span>
            `).join('');
            
            // Render activity
            const activityContainer = document.getElementById('detailActivity');
            activityContainer.innerHTML = selectedTask.activity.map(item => `
                <div class="activity-item">
                    <span class="activity-time">${item.time}</span>
                    <span class="activity-content">
                        <span class="activity-user">${item.user}</span>
                        ${item.action}
                    </span>
                </div>
            `).join('');
        }

        function closeTaskDetail() {
            document.getElementById('taskDetailModal').classList.remove('active');
            selectedTask = null;
        }

        function updateTaskStatus() {
            if (!selectedTask) return;
            const newStatus = document.getElementById('detailStatus').value;
            selectedTask.status = newStatus;
            selectedTask.activity.unshift({
                time: 'now',
                user: 'You',
                action: `changed status to ${newStatus}`
            });
            renderTasks();
            showTaskDetail(selectedTask.id);
        }

        function updateTaskPriority() {
            if (!selectedTask) return;
            const newPriority = document.getElementById('detailPriority').value;
            selectedTask.priority = newPriority;
            selectedTask.activity.unshift({
                time: 'now',
                user: 'You',
                action: `changed priority to ${newPriority}`
            });
            renderTasks();
            showTaskDetail(selectedTask.id);
        }

        function addTag() {
            if (!selectedTask) return;
            const tag = prompt('Enter tag name:');
            if (tag && !selectedTask.tags.includes(tag)) {
                selectedTask.tags.push(tag);
                selectedTask.activity.unshift({
                    time: 'now',
                    user: 'You',
                    action: `added tag: ${tag}`
                });
                renderTasks();
                showTaskDetail(selectedTask.id);
            }
        }

        function filterTasks() {
            taskFilter = document.getElementById('taskFilter').value;
            renderTasks();
        }

        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function setError(element, errorElement, show, message) {
            if (!element || !errorElement) return;
            if (message) {
                errorElement.textContent = message;
            }
            if (show) {
                errorElement.classList.add('active');
                element.classList.add('error');
            } else {
                errorElement.classList.remove('active');
                element.classList.remove('error');
            }
        }

        function resetCustomSelect(selectId, placeholder, defaultValue = '') {
            const selectElement = document.getElementById(selectId + 'Select');
            if (!selectElement) return;

            const valueSpan = selectElement.querySelector('.select-value');
            const trigger = selectElement.querySelector('.select-trigger');
            const optionsContainer = selectElement.querySelector('.select-options');
            const options = optionsContainer ? optionsContainer.querySelectorAll('.select-option') : [];
            const displayValue = defaultValue || placeholder;

            valueSpan.textContent = displayValue;
            valueSpan.setAttribute('data-value', defaultValue);

            options.forEach(opt => {
                opt.classList.remove('selected', 'highlight');
                if (defaultValue && opt.textContent === defaultValue) {
                    opt.classList.add('selected');
                }
            });

            if (trigger) {
                trigger.classList.remove('active');
            }
            if (optionsContainer) {
                optionsContainer.classList.remove('active');
                optionsContainer.removeAttribute('data-highlight-index');
            }
        }

        function updateFlowPreview() {
            const preview = document.getElementById('flowPreview');
            if (!preview) return;

            const operandInput = document.getElementById('operand');
            const operandValue = operandInput ? operandInput.value.trim() : '';
            const from = selectedValues.fromRole || 'Source Role';
            const operatorDisplay = selectedOperator || selectedCoreCategory || 'operator';
            const preposition = selectedValues.preposition || 'to';
            const to = selectedValues.toRole || 'Target Role';

            const fromEl = document.getElementById('previewFrom');
            const operatorEl = document.getElementById('previewOperator');
            const operandEl = document.getElementById('previewOperand');
            const prepositionEl = document.getElementById('previewPreposition');
            const toEl = document.getElementById('previewTo');

            if (fromEl) fromEl.textContent = from;
            if (operatorEl) {
                operatorEl.textContent = operatorDisplay;
                operatorEl.className = 'preview-operator';
                if (selectedCoreCategory) {
                    operatorEl.classList.add(selectedCoreCategory);
                }
            }
            if (operandEl) operandEl.textContent = operandValue ? `"${operandValue}"` : '';
            if (prepositionEl) prepositionEl.textContent = preposition || 'to';
            if (toEl) toEl.textContent = to;

            const isEmpty = !selectedValues.fromRole && !selectedCoreCategory && !operandValue && !selectedValues.toRole;
            const isReady = !!(selectedValues.fromRole && selectedCoreCategory && operandValue && selectedValues.toRole);

            preview.classList.toggle('is-empty', isEmpty);
            preview.classList.toggle('ready', isReady);
        }

        function updateFlowProgress() {
            const progress = document.getElementById('flowProgress');
            if (!progress) return;

            const operandFilled = !!(document.getElementById('operand')?.value.trim());
            const status = {
                source: !!selectedValues.fromRole,
                action: !!selectedCoreCategory && operandFilled,
                target: !!selectedValues.toRole
            };

            progress.querySelectorAll('.progress-step').forEach(step => {
                const key = step.dataset.step;
                step.classList.toggle('completed', !!status[key]);
                step.classList.remove('active');
            });

            const nextStep = !status.source ? 'source' : !status.action ? 'action' : !status.target ? 'target' : null;
            if (nextStep) {
                const activeStep = progress.querySelector(`.progress-step[data-step="${nextStep}"]`);
                if (activeStep) activeStep.classList.add('active');
            } else {
                const finalStep = progress.querySelector('.progress-step[data-step="target"]');
                if (finalStep) finalStep.classList.add('active');
            }

            progress.querySelectorAll('.progress-line').forEach(line => {
                const key = line.dataset.line;
                line.classList.remove('active', 'completed');
                if (key === 'source') {
                    if (status.source && status.action) {
                        line.classList.add('completed');
                    } else if (status.source) {
                        line.classList.add('active');
                    }
                } else if (key === 'action') {
                    if (status.action && status.target) {
                        line.classList.add('completed');
                    } else if (status.action) {
                        line.classList.add('active');
                    }
                }
            });
        }

        function suggestCompletion() {
            const container = document.getElementById('flowSuggestions');
            if (!container) return;

            const operandValue = document.getElementById('operand')?.value.trim().toLowerCase() || '';
            const operatorValue = selectedOperator || selectedCoreCategory || '';
            const fromValue = selectedValues.fromRole || '';
            const toValue = selectedValues.toRole || '';

            let matches = commonFlows.filter(flow => (
                (!fromValue || flow.from === fromValue) &&
                (!operatorValue || flow.operator === operatorValue || flow.operator === selectedCoreCategory) &&
                (!toValue || flow.to === toValue)
            ));

            if (!matches.length && operandValue) {
                matches = commonFlows.filter(flow => flow.operand.toLowerCase().includes(operandValue));
            }

            if (matches.length) {
                container.innerHTML = matches.slice(0, 4).map(flow => {
                    const label = `${escapeHtml(flow.from)} ${escapeHtml(flow.operator)} "${escapeHtml(flow.operand)}" ${escapeHtml(flow.preposition || 'to')} ${escapeHtml(flow.to)}`;
                    return `<button type="button" class="suggestion-pill" data-from="${escapeHtml(flow.from)}" data-operator="${escapeHtml(flow.operator)}" data-operand="${escapeHtml(flow.operand)}" data-preposition="${escapeHtml(flow.preposition || 'to')}" data-to="${escapeHtml(flow.to)}">${label}</button>`;
                }).join('');
            } else {
                container.innerHTML = '<div class="suggestion-placeholder">No direct matches yet. Continue configuring the flow.</div>';
            }
        }

        // Modal and dropdowns
        function toggleDropdown(selectId) {
            const selectElement = document.getElementById(selectId + 'Select');
            if (!selectElement) return;
            const trigger = selectElement.querySelector('.select-trigger');
            const options = selectElement.querySelector('.select-options');

            document.querySelectorAll('.custom-select').forEach(sel => {
                if (sel !== selectElement) {
                    sel.querySelector('.select-trigger').classList.remove('active');
                    const selOptions = sel.querySelector('.select-options');
                    selOptions.classList.remove('active');
                    selOptions.removeAttribute('data-highlight-index');
                    selOptions.querySelectorAll('.select-option').forEach(opt => opt.classList.remove('highlight'));
                }
            });

            trigger.classList.toggle('active');
            options.classList.toggle('active');
            options.removeAttribute('data-highlight-index');
            options.querySelectorAll('.select-option').forEach(opt => opt.classList.remove('highlight'));

            document.addEventListener('click', function closeDropdown(e) {
                if (!selectElement.contains(e.target)) {
                    trigger.classList.remove('active');
                    options.classList.remove('active');
                    options.removeAttribute('data-highlight-index');
                    options.querySelectorAll('.select-option').forEach(opt => opt.classList.remove('highlight'));
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function handleDropdownKeyboard(e, selectId) {
            const selectElement = document.getElementById(selectId + 'Select');
            if (!selectElement) return;
            const trigger = selectElement.querySelector('.select-trigger');
            const optionsContainer = selectElement.querySelector('.select-options');
            const options = Array.from(optionsContainer.querySelectorAll('.select-option'));
            if (!options.length) return;

            let index = parseInt(optionsContainer.getAttribute('data-highlight-index') || '-1', 10);

            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                if (!optionsContainer.classList.contains('active')) {
                    toggleDropdown(selectId);
                }
                if (index === -1) {
                    index = options.findIndex(opt => opt.classList.contains('selected'));
                }
                if (index === -1) {
                    index = e.key === 'ArrowDown' ? 0 : options.length - 1;
                } else {
                    const delta = e.key === 'ArrowDown' ? 1 : -1;
                    index = (index + delta + options.length) % options.length;
                }
                options.forEach(opt => opt.classList.remove('highlight'));
                options[index].classList.add('highlight');
                optionsContainer.setAttribute('data-highlight-index', index);
                options[index].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter' || e.key === ' ') {
                if (!optionsContainer.classList.contains('active')) {
                    e.preventDefault();
                    toggleDropdown(selectId);
                } else {
                    e.preventDefault();
                    const highlighted = options.find(opt => opt.classList.contains('highlight')) ||
                        options.find(opt => opt.classList.contains('selected')) ||
                        options[0];
                    if (highlighted) {
                        highlighted.click();
                    }
                }
            } else if (e.key === 'Escape') {
                if (optionsContainer.classList.contains('active')) {
                    e.preventDefault();
                    trigger.classList.remove('active');
                    optionsContainer.classList.remove('active');
                    optionsContainer.removeAttribute('data-highlight-index');
                    options.forEach(opt => opt.classList.remove('highlight'));
                }
            }
        }

        function selectOption(selectId, value, evt) {
            if (evt) {
                evt.stopPropagation();
            }

            const selectElement = document.getElementById(selectId + 'Select');
            if (!selectElement) return;

            const valueSpan = selectElement.querySelector('.select-value');
            const trigger = selectElement.querySelector('.select-trigger');
            const options = selectElement.querySelector('.select-options');

            valueSpan.textContent = value;
            valueSpan.setAttribute('data-value', value);

            selectElement.querySelectorAll('.select-option').forEach(opt => {
                opt.classList.remove('selected', 'highlight');
                if (opt.textContent === value) {
                    opt.classList.add('selected');
                }
            });

            selectedValues[selectId] = value;

            trigger.classList.remove('active');
            options.classList.remove('active');
            options.removeAttribute('data-highlight-index');

            if (selectId === 'fromRole') {
                setError(selectElement, document.getElementById('fromRoleError'), false);
            } else if (selectId === 'toRole') {
                setError(selectElement, document.getElementById('toRoleError'), false);
            } else if (selectId === 'podFromRole') {
                setError(selectElement, document.getElementById('podFromRoleError'), false);
            } else if (selectId === 'toPod') {
                setError(selectElement, document.getElementById('toPodError'), false);
            } else if (selectId === 'podToRole') {
                setError(selectElement, document.getElementById('podToRoleError'), false);
            }

            if (selectId === 'fromRole' || selectId === 'toRole' || selectId === 'preposition') {
                updateFlowPreview();
                updateFlowProgress();
                suggestCompletion();
            }
        }

        function applySuggestion(from, operator, operand, to, preposition = 'to') {
            if (from) selectOption('fromRole', from);
            if (operator) {
                let category = operator;
                if (!['shares', 'does', 'okays'].includes(operator)) {
                    category = Object.keys(categoryMap).find(cat => (categoryMap[cat] || []).includes(operator)) || category;
                }
                if (category) {
                    selectCoreCategory(category);
                    if (categoryMap[category] && categoryMap[category].includes(operator)) {
                        setTimeout(() => {
                            const option = document.querySelector(`#operatorGrid .operator-option[data-op="${operator}"]`);
                            if (option) {
                                selectModalOperator(option);
                            }
                        }, 50);
                    } else {
                        selectedOperator = operator;
                    }
                }
            }
            if (operand) {
                const operandInput = document.getElementById('operand');
                operandInput.value = operand;
                setError(operandInput, document.getElementById('operandError'), false);
            }
            if (preposition) {
                selectOption('preposition', preposition);
            }
            if (to) selectOption('toRole', to);

            updateFlowPreview();
            updateFlowProgress();
            suggestCompletion();
        }

        function selectCoreCategory(category) {
            selectedCoreCategory = category;

            document.querySelectorAll('#flowModal [data-core]').forEach(opt => {
                opt.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`#flowModal [data-core="${category}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            const coreGrid = document.getElementById('coreOperatorGrid');
            setError(coreGrid, document.getElementById('operatorError'), false);

            document.getElementById('detailedOperatorRow').style.display = 'block';
            populateDetailedOperators(category);
            selectedOperator = null;
            updateFlowPreview();
            updateFlowProgress();
            suggestCompletion();
        }
        
        function populateDetailedOperators(category) {
            const grid = document.getElementById('operatorGrid');
            const operators = categoryMap[category] || [];

            grid.innerHTML = operators.map(op => `
                <div class="operator-option ${category}" data-op="${op}" onclick="selectModalOperator(this)">
                    ${op}
                </div>
            `).join('');

            grid.style.gridTemplateColumns = operators.length === 4 ? 'repeat(2, 1fr)' :
                                              operators.length === 3 ? 'repeat(3, 1fr)' :
                                              'repeat(2, 1fr)';
        }

        function selectOperator(op, cat) {
            selectedOperator = op;
            selectedCategory = cat;
            selectedCoreCategory = cat;
            openFlowBuilder();

            selectCoreCategory(cat);

            setTimeout(() => {
                const option = document.querySelector(`#operatorGrid .operator-option[data-op="${op}"]`);
                if (option) {
                    selectModalOperator(option);
                }
            }, 60);
        }

        function selectModalOperator(element) {
            document.querySelectorAll('#operatorGrid .operator-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedOperator = element.dataset.op;
            updateFlowPreview();
            updateFlowProgress();
            suggestCompletion();
        }

        function openFlowBuilder() {
            const modal = document.getElementById('flowModal');
            modal.classList.add('active');
            document.getElementById('detailedOperatorRow').style.display = selectedCoreCategory ? 'block' : 'none';
            updateFlowPreview();
            updateFlowProgress();
            suggestCompletion();
        }

        function closeModal() {
            document.getElementById('flowModal').classList.remove('active');
            selectedValues = { fromRole: '', preposition: 'to', toRole: '' };
            const operandInput = document.getElementById('operand');
            if (operandInput) {
                operandInput.value = '';
                setError(operandInput, document.getElementById('operandError'), false);
            }
            document.querySelectorAll('#flowModal [data-core]').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('#operatorGrid .operator-option').forEach(opt => opt.classList.remove('selected'));
            selectedOperator = null;
            selectedCategory = null;
            selectedCoreCategory = null;
            document.getElementById('detailedOperatorRow').style.display = 'none';
            resetCustomSelect('fromRole', 'Select role...');
            resetCustomSelect('toRole', 'Select role...');
            resetCustomSelect('preposition', 'to', 'to');
            setError(document.getElementById('fromRoleSelect'), document.getElementById('fromRoleError'), false);
            setError(document.getElementById('toRoleSelect'), document.getElementById('toRoleError'), false);
            setError(document.getElementById('coreOperatorGrid'), document.getElementById('operatorError'), false);
            const createButton = document.querySelector('#flowModal .modal-btn-primary');
            if (createButton) {
                createButton.classList.remove('loading');
                createButton.disabled = false;
            }
            updateFlowPreview();
            updateFlowProgress();
            suggestCompletion();
        }

        function createFlow() {
            const fromRole = selectedValues.fromRole;
            const operandInput = document.getElementById('operand');
            const operand = operandInput.value.trim();
            const toRole = selectedValues.toRole;
            const createButton = document.querySelector('#flowModal .modal-btn-primary');

            let hasError = false;

            if (!fromRole) {
                setError(document.getElementById('fromRoleSelect'), document.getElementById('fromRoleError'), true, 'Select a source role');
                hasError = true;
            }
            if (!selectedCoreCategory) {
                setError(document.getElementById('coreOperatorGrid'), document.getElementById('operatorError'), true, 'Select a core operator');
                hasError = true;
            }
            if (!operand) {
                setError(operandInput, document.getElementById('operandError'), true, 'This field is required');
                hasError = true;
            }
            if (!toRole) {
                setError(document.getElementById('toRoleSelect'), document.getElementById('toRoleError'), true, 'Select a destination role');
                hasError = true;
            }

            if (hasError) {
                updateFlowProgress();
                return;
            }

            if (createButton) {
                createButton.classList.add('loading');
                createButton.disabled = true;
            }

            const payload = {
                from: fromRole,
                operator: selectedOperator || selectedCoreCategory,
                operand: operand,
                preposition: selectedValues.preposition,
                to: toRole,
                category: selectedCoreCategory,
                timestamp: new Date().toISOString(),
                consent: { from: 'pending', to: 'pending' }
            };

            setTimeout(() => {
                flows.push(payload);
                renderFlows();
                closeModal();
                if (createButton) {
                    createButton.classList.remove('loading');
                    createButton.disabled = false;
                }
            }, 300);
        }

        function editFlow(index) {
            alert(`Edit flow ${index}`);
        }

        function deleteFlow(index) {
            if (confirm('Delete this flow?')) {
                flows.splice(index, 1);
                renderFlows();
            }
        }

        function quickAdd(role) {
            const name = prompt(`Add person to ${role} role:`);
            if (name) {
                alert(`Adding ${name} to ${role}`);
            }
        }

        // Network tab functions
        function renderNetwork() {
            renderConnectedPods();
            renderPodFlows();
        }

        function renderConnectedPods() {
            const container = document.getElementById('connectedPods');
            if (!container) return;

            container.innerHTML = `
                ${connectedPods.map(pod => `
                    <div class="pod-card">
                        <div class="pod-card-header">
                            <div class="pod-name">${pod.name}</div>
                            <div class="pod-health">
                                <span class="health-value">${pod.health}%</span>
                                <span style="color: var(--text-dim);">health</span>
                            </div>
                        </div>
                        <div class="pod-stats">
                            <div class="pod-stat">
                                <span class="pod-stat-value">${pod.rolesFilled}/${pod.totalRoles}</span>
                                <span class="pod-stat-label">roles</span>
                            </div>
                            <div class="pod-stat">
                                <span class="pod-stat-value">${pod.activeFlows}</span>
                                <span class="pod-stat-label">flows</span>
                            </div>
                        </div>
                        <div class="pod-flows">
                            <div class="pod-flow-count">CONNECTION TYPES</div>
                            <div class="pod-flow-indicators">
                                ${pod.flowTypes.shares > 0 ? `<div class="flow-indicator shares" style="flex: ${pod.flowTypes.shares}"></div>` : ''}
                                ${pod.flowTypes.does > 0 ? `<div class="flow-indicator does" style="flex: ${pod.flowTypes.does}"></div>` : ''}
                                ${pod.flowTypes.okays > 0 ? `<div class="flow-indicator okays" style="flex: ${pod.flowTypes.okays}"></div>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
                <button class="add-pod-btn" onclick="addNewPod()">
                    <div class="add-pod-icon">+</div>
                    <div>Connect New Pod</div>
                </button>
            `;
        }

        function renderPodFlows() {
            const container = document.getElementById('podFlowsList');
            if (!container) return;

            let displayFlows = podFlows;
            
            if (flowTypeFilter === 'incoming') {
                displayFlows = podFlows.filter(f => f.to === 'NORTHSIDE RESPONSE' || (f.toRole && f.to === 'NORTHSIDE RESPONSE'));
            } else if (flowTypeFilter === 'outgoing') {
                displayFlows = podFlows.filter(f => f.from === 'NORTHSIDE RESPONSE');
            }

            container.innerHTML = displayFlows.map((flow, index) => {
                let fromDisplay = flow.from;
                let toDisplay = flow.to;
                
                if (flow.fromRole) {
                    fromDisplay = `${flow.from}.${flow.fromRole}`;
                }
                if (flow.toRole) {
                    toDisplay = `${flow.to}.${flow.toRole}`;
                }

                const timeAgo = getTimeAgo(flow.timestamp);
                const consentStatus = getConsentStatus(flow.consent);

                return `
                    <div class="pod-flow-item ${flow.category}-flow">
                        <div class="pod-flow-content">
                            <div class="pod-badge">${flow.type === 'pod-to-pod' ? 'POD' : flow.type === 'role-to-role' ? 'ROLE' : 'MIXED'}</div>
                            <span style="font-weight: 600;">${fromDisplay}</span>
                            <span class="flow-arrow"></span>
                            <div class="flow-operator">${flow.operator}</div>
                            <div class="flow-operand" style="font-style: italic; color: var(--text-dim);">"${flow.operand}"</div>
                            <span class="flow-arrow"></span>
                            <span style="font-weight: 600;">${toDisplay}</span>
                        </div>
                        <div class="flow-meta">
                            <div class="flow-timestamp">${timeAgo}</div>
                            <div class="consent-status ${consentStatus.class}">
                                <span class="consent-dot"></span>
                                ${consentStatus.text}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setFlowType(type) {
            flowTypeFilter = type;
            document.querySelectorAll('.flow-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderPodFlows();
        }

        function openPodFlowBuilder() {
            document.getElementById('podFlowModal').classList.add('active');
            setPodFlowType('pod-to-pod');
        }

        function closePodModal() {
            document.getElementById('podFlowModal').classList.remove('active');
            selectedValues.podFromRole = '';
            selectedValues.toPod = '';
            selectedValues.podToRole = '';
            const podOperandInput = document.getElementById('podOperand');
            if (podOperandInput) {
                podOperandInput.value = '';
                setError(podOperandInput, document.getElementById('podOperandError'), false);
            }
            selectedPodCoreCategory = null;
            document.querySelectorAll('#podFlowModal [data-core]').forEach(opt => opt.classList.remove('selected'));
            resetCustomSelect('podFromRole', 'Select role...');
            resetCustomSelect('toPod', 'Select pod...');
            resetCustomSelect('podToRole', 'Select role...');
            setError(document.getElementById('podFromRoleSelect'), document.getElementById('podFromRoleError'), false);
            setError(document.getElementById('toPodSelect'), document.getElementById('toPodError'), false);
            setError(document.getElementById('podToRoleSelect'), document.getElementById('podToRoleError'), false);
            setError(document.getElementById('podCoreOperatorGrid'), document.getElementById('podCoreError'), false);
            const createButton = document.querySelector('#podFlowModal .modal-btn-primary');
            if (createButton) {
                createButton.classList.remove('loading');
                createButton.disabled = false;
            }
            setPodFlowType('pod-to-pod');
        }

        function setPodFlowType(type) {
            podFlowType = type;

            document.querySelectorAll('#podConnectionGrid [data-type]').forEach(opt => {
                opt.classList.remove('selected');
            });
            const selectedType = document.querySelector(`#podConnectionGrid [data-type="${type}"]`);
            if (selectedType) {
                selectedType.classList.add('selected');
            }

            const fromRoleRow = document.getElementById('podFromRoleRow');
            const toRoleRow = document.getElementById('podToRoleRow');

            if (type === 'pod-to-pod') {
                fromRoleRow.style.display = 'none';
                toRoleRow.style.display = 'none';
                selectedValues.podFromRole = '';
                selectedValues.podToRole = '';
                resetCustomSelect('podFromRole', 'Select role...');
                resetCustomSelect('podToRole', 'Select role...');
                setError(document.getElementById('podFromRoleSelect'), document.getElementById('podFromRoleError'), false);
                setError(document.getElementById('podToRoleSelect'), document.getElementById('podToRoleError'), false);
            } else if (type === 'role-to-role') {
                fromRoleRow.style.display = 'block';
                toRoleRow.style.display = 'block';
            } else if (type === 'pod-to-role') {
                fromRoleRow.style.display = 'none';
                toRoleRow.style.display = 'block';
                selectedValues.podFromRole = '';
                resetCustomSelect('podFromRole', 'Select role...');
                setError(document.getElementById('podFromRoleSelect'), document.getElementById('podFromRoleError'), false);
            }
        }

        function selectPodCoreCategory(category) {
            selectedPodCoreCategory = category;

            document.querySelectorAll('#podFlowModal [data-core]').forEach(opt => opt.classList.remove('selected'));
            const selectedOption = document.querySelector(`#podFlowModal [data-core="${category}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            setError(document.getElementById('podCoreOperatorGrid'), document.getElementById('podCoreError'), false);
        }

        function createPodFlow() {
            const operandInput = document.getElementById('podOperand');
            const operand = operandInput.value.trim();
            const to = selectedValues.toPod;
            const fromRoleSelect = document.getElementById('podFromRoleSelect');
            const toPodSelect = document.getElementById('toPodSelect');
            const toRoleSelect = document.getElementById('podToRoleSelect');
            const createButton = document.querySelector('#podFlowModal .modal-btn-primary');

            let hasError = false;

            if (!selectedPodCoreCategory) {
                setError(document.getElementById('podCoreOperatorGrid'), document.getElementById('podCoreError'), true, 'Select a core operator');
                hasError = true;
            }

            if (!operand) {
                setError(operandInput, document.getElementById('podOperandError'), true, 'Provide an operand');
                hasError = true;
            } else {
                setError(operandInput, document.getElementById('podOperandError'), false);
            }

            if (!to) {
                setError(toPodSelect, document.getElementById('toPodError'), true, 'Select a destination pod');
                hasError = true;
            } else {
                setError(toPodSelect, document.getElementById('toPodError'), false);
            }

            if (podFlowType === 'role-to-role') {
                if (!selectedValues.podFromRole) {
                    setError(fromRoleSelect, document.getElementById('podFromRoleError'), true, 'Select a source role');
                    hasError = true;
                } else {
                    setError(fromRoleSelect, document.getElementById('podFromRoleError'), false);
                }
                if (!selectedValues.podToRole) {
                    setError(toRoleSelect, document.getElementById('podToRoleError'), true, 'Select a receiving role');
                    hasError = true;
                } else {
                    setError(toRoleSelect, document.getElementById('podToRoleError'), false);
                }
            } else if (podFlowType === 'pod-to-role') {
                if (!selectedValues.podToRole) {
                    setError(toRoleSelect, document.getElementById('podToRoleError'), true, 'Select a receiving role');
                    hasError = true;
                } else {
                    setError(toRoleSelect, document.getElementById('podToRoleError'), false);
                }
                setError(fromRoleSelect, document.getElementById('podFromRoleError'), false);
            } else {
                setError(fromRoleSelect, document.getElementById('podFromRoleError'), false);
                setError(toRoleSelect, document.getElementById('podToRoleError'), false);
            }

            if (hasError) return;

            if (createButton) {
                createButton.classList.add('loading');
                createButton.disabled = true;
            }

            const payload = {
                type: podFlowType,
                from: 'NORTHSIDE RESPONSE',
                fromRole: podFlowType !== 'pod-to-pod' ? selectedValues.podFromRole || null : null,
                operator: selectedPodCoreCategory,
                operand: operand,
                to: to,
                toRole: (podFlowType === 'role-to-role' || podFlowType === 'pod-to-role') ? selectedValues.podToRole || null : null,
                category: selectedPodCoreCategory,
                timestamp: new Date().toISOString(),
                consent: { from: 'pending', to: 'pending' }
            };

            setTimeout(() => {
                podFlows.push(payload);

                if (to === '[New Pod]') {
                    const newPodName = prompt('Enter new pod name:');
                    if (newPodName) {
                        connectedPods.push({
                            name: newPodName,
                            health: 75,
                            rolesFilled: 0,
                            totalRoles: 9,
                            activeFlows: 1,
                            flowTypes: { shares: 0, does: 0, okays: 0 }
                        });
                        podFlows[podFlows.length - 1].to = newPodName;
                    }
                }

                renderNetwork();
                closePodModal();

                if (createButton) {
                    createButton.classList.remove('loading');
                    createButton.disabled = false;
                }
            }, 300);
        }

        function addNewPod() {
            openPodFlowBuilder();
        }

        const suggestionsContainer = document.getElementById('flowSuggestions');
        if (suggestionsContainer) {
            suggestionsContainer.addEventListener('click', (e) => {
                const pill = e.target.closest('.suggestion-pill');
                if (!pill) return;
                applySuggestion(pill.dataset.from, pill.dataset.operator, pill.dataset.operand, pill.dataset.to, pill.dataset.preposition);
            });
        }

        const operandInput = document.getElementById('operand');
        if (operandInput) {
            operandInput.addEventListener('input', () => {
                setError(operandInput, document.getElementById('operandError'), false);
                updateFlowPreview();
                updateFlowProgress();
                suggestCompletion();
            });
        }

        const podOperandInput = document.getElementById('podOperand');
        if (podOperandInput) {
            podOperandInput.addEventListener('input', () => {
                setError(podOperandInput, document.getElementById('podOperandError'), false);
            });
        }

        const flowFab = document.getElementById('openFlowFab');
        if (flowFab) {
            flowFab.addEventListener('click', () => {
                openFlowBuilder();
            });
        }

        const flowModalElement = document.getElementById('flowModal');
        if (flowModalElement) {
            flowModalElement.addEventListener('click', (event) => {
                if (event.target === flowModalElement) {
                    closeModal();
                }
            });
        }

        const podFlowModalElement = document.getElementById('podFlowModal');
        if (podFlowModalElement) {
            podFlowModalElement.addEventListener('click', (event) => {
                if (event.target === podFlowModalElement) {
                    closePodModal();
                }
            });
        }

        const profileModalElement = document.getElementById('profileModal');
        if (profileModalElement) {
            profileModalElement.addEventListener('click', (event) => {
                if (event.target === profileModalElement) {
                    closeProfile();
                }
            });
        }

        const taskDetailModalElement = document.getElementById('taskDetailModal');
        if (taskDetailModalElement) {
            document.addEventListener('click', (event) => {
                if (!taskDetailModalElement.classList.contains('active')) return;
                if (taskDetailModalElement.contains(event.target)) return;
                closeTaskDetail();
            });
        }

        document.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' && (e.ctrlKey || e.metaKey))) {
                if (document.getElementById('flowModal').classList.contains('active')) {
                    e.preventDefault();
                    createFlow();
                    return;
                }
                if (document.getElementById('podFlowModal').classList.contains('active')) {
                    e.preventDefault();
                    createPodFlow();
                    return;
                }
            }
            if (e.key === 'Escape') {
                let handled = false;
                if (document.getElementById('flowModal').classList.contains('active')) {
                    closeModal();
                    handled = true;
                }
                if (document.getElementById('podFlowModal').classList.contains('active')) {
                    closePodModal();
                    handled = true;
                }
                if (!handled && document.getElementById('profileModal')?.classList.contains('active')) {
                    closeProfile();
                    handled = true;
                }
                if (!handled && document.getElementById('taskDetailModal')?.classList.contains('active')) {
                    closeTaskDetail();
                }
            }
        });
    </script>
</body>
</html>
